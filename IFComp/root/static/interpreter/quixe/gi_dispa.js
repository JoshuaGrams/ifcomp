var GiDispa=function(){var e={};e.VM=null;var n={0:"window",1:"stream",2:"fileref",3:"schannel"};function r(e,n,r){this.id=e,this.name=n,this.proto=r}function t(e,n){this.args=e,this.retarg=n}function w(){this.macro="Byte",this.refsize=1,this.serialize=function(){return{type:"ArgString"}}}function l(){this.macro="Word",this.refsize=4,this.serialize=function(){return{type:"ArgUnicode"}}}function s(e){this.signed=e,this.macro="Byte",this.refsize=1,this.literal=e?"arg_char_signed":"arg_char_unsigned",this.serialize=function(){return{type:"ArgChar",signed:e}}}function i(e){this.signed=e,this.macro="Word",this.refsize=4,this.literal=e?"arg_int_signed":"arg_int_unsigned",this.serialize=function(){return{type:"ArgInt",signed:e}}}function a(e){this.name=e,this.macro="Word",this.refsize=4}function u(e){this.form=e}function _(e,n,r,t){this.arg=e,this.passin=n,this.passout=r,this.nonnull=t}function o(e,n,r,t,w){this.arg=e,this.retained=n,this.passin=r,this.passout=t,this.nonnull=w}function c(e){switch(e.type){case"ArgString":return new w;case"ArgUnicode":return new l;case"ArgInt":return e.signed?g:f;case"ArgChar":return null===e.signed?d:e.signed?p:h}throw new Error("arg_deserialize: unknown type: "+e.type)}var f=new i(!1),g=new i(!0),h=new s(!1),d=new s(null),p=new s(!0),m=new a("window"),y=new a("stream"),k=new a("fileref"),v=new a("schannel"),b={1:new r(1,"exit",new t([],null)),3:new r(3,"tick",new t([],null)),4:new r(4,"gestalt",new t([f,f],new _(f,!1,!0,!0))),5:new r(5,"gestalt_ext",new t([f,f,new o(f,!1,!0,!0,!1)],new _(f,!1,!0,!0))),32:new r(32,"window_iterate",new t([m,new _(f,!1,!0,!1)],new _(m,!1,!0,!0))),33:new r(33,"window_get_rock",new t([m],new _(f,!1,!0,!0))),34:new r(34,"window_get_root",new t([],new _(m,!1,!0,!0))),35:new r(35,"window_open",new t([m,f,f,f,f],new _(m,!1,!0,!0))),36:new r(36,"window_close",new t([m,new _(new u(new t([f,f],null)),!1,!0,!1)],null)),37:new r(37,"window_get_size",new t([m,new _(f,!1,!0,!1),new _(f,!1,!0,!1)],null)),38:new r(38,"window_set_arrangement",new t([m,f,f,m],null)),39:new r(39,"window_get_arrangement",new t([m,new _(f,!1,!0,!1),new _(f,!1,!0,!1),new _(m,!1,!0,!1)],null)),40:new r(40,"window_get_type",new t([m],new _(f,!1,!0,!0))),41:new r(41,"window_get_parent",new t([m],new _(m,!1,!0,!0))),42:new r(42,"window_clear",new t([m],null)),43:new r(43,"window_move_cursor",new t([m,f,f],null)),44:new r(44,"window_get_stream",new t([m],new _(y,!1,!0,!0))),45:new r(45,"window_set_echo_stream",new t([m,y],null)),46:new r(46,"window_get_echo_stream",new t([m],new _(y,!1,!0,!0))),47:new r(47,"set_window",new t([m],null)),48:new r(48,"window_get_sibling",new t([m],new _(m,!1,!0,!0))),64:new r(64,"stream_iterate",new t([y,new _(f,!1,!0,!1)],new _(y,!1,!0,!0))),65:new r(65,"stream_get_rock",new t([y],new _(f,!1,!0,!0))),66:new r(66,"stream_open_file",new t([k,f,f],new _(y,!1,!0,!0))),67:new r(67,"stream_open_memory",new t([new o(d,!0,!0,!0,!1),f,f],new _(y,!1,!0,!0))),68:new r(68,"stream_close",new t([y,new _(new u(new t([f,f],null)),!1,!0,!1)],null)),69:new r(69,"stream_set_position",new t([y,g,f],null)),70:new r(70,"stream_get_position",new t([y],new _(f,!1,!0,!0))),71:new r(71,"stream_set_current",new t([y],null)),72:new r(72,"stream_get_current",new t([],new _(y,!1,!0,!0))),73:new r(73,"stream_open_resource",new t([f,f],new _(y,!1,!0,!0))),96:new r(96,"fileref_create_temp",new t([f,f],new _(k,!1,!0,!0))),97:new r(97,"fileref_create_by_name",new t([f,new w,f],new _(k,!1,!0,!0))),98:new r(98,"fileref_create_by_prompt",new t([f,f,f],new _(k,!1,!0,!0))),99:new r(99,"fileref_destroy",new t([k],null)),100:new r(100,"fileref_iterate",new t([k,new _(f,!1,!0,!1)],new _(k,!1,!0,!0))),101:new r(101,"fileref_get_rock",new t([k],new _(f,!1,!0,!0))),102:new r(102,"fileref_delete_file",new t([k],null)),103:new r(103,"fileref_does_file_exist",new t([k],new _(f,!1,!0,!0))),104:new r(104,"fileref_create_from_fileref",new t([f,k,f],new _(k,!1,!0,!0))),128:new r(128,"put_char",new t([h],null)),129:new r(129,"put_char_stream",new t([y,h],null)),130:new r(130,"put_string",new t([new w],null)),131:new r(131,"put_string_stream",new t([y,new w],null)),132:new r(132,"put_buffer",new t([new o(d,!1,!0,!1,!0)],null)),133:new r(133,"put_buffer_stream",new t([y,new o(d,!1,!0,!1,!0)],null)),134:new r(134,"set_style",new t([f],null)),135:new r(135,"set_style_stream",new t([y,f],null)),144:new r(144,"get_char_stream",new t([y],new _(g,!1,!0,!0))),145:new r(145,"get_line_stream",new t([y,new o(d,!1,!1,!0,!0)],new _(f,!1,!0,!0))),146:new r(146,"get_buffer_stream",new t([y,new o(d,!1,!1,!0,!0)],new _(f,!1,!0,!0))),160:new r(160,"char_to_lower",new t([h],new _(h,!1,!0,!0))),161:new r(161,"char_to_upper",new t([h],new _(h,!1,!0,!0))),176:new r(176,"stylehint_set",new t([f,f,f,g],null)),177:new r(177,"stylehint_clear",new t([f,f,f],null)),178:new r(178,"style_distinguish",new t([m,f,f],new _(f,!1,!0,!0))),179:new r(179,"style_measure",new t([m,f,f,new _(f,!1,!0,!1)],new _(f,!1,!0,!0))),192:new r(192,"select",new t([new _(new u(new t([f,m,f,f],null)),!1,!0,!0)],null)),193:new r(193,"select_poll",new t([new _(new u(new t([f,m,f,f],null)),!1,!0,!0)],null)),208:new r(208,"request_line_event",new t([m,new o(d,!0,!0,!0,!0),f],null)),209:new r(209,"cancel_line_event",new t([m,new _(new u(new t([f,m,f,f],null)),!1,!0,!1)],null)),210:new r(210,"request_char_event",new t([m],null)),211:new r(211,"cancel_char_event",new t([m],null)),212:new r(212,"request_mouse_event",new t([m],null)),213:new r(213,"cancel_mouse_event",new t([m],null)),214:new r(214,"request_timer_events",new t([f],null)),224:new r(224,"image_get_info",new t([f,new _(f,!1,!0,!1),new _(f,!1,!0,!1)],new _(f,!1,!0,!0))),225:new r(225,"image_draw",new t([m,f,g,g],new _(f,!1,!0,!0))),226:new r(226,"image_draw_scaled",new t([m,f,g,g,f,f],new _(f,!1,!0,!0))),232:new r(232,"window_flow_break",new t([m],null)),233:new r(233,"window_erase_rect",new t([m,g,g,f,f],null)),234:new r(234,"window_fill_rect",new t([m,f,g,g,f,f],null)),235:new r(235,"window_set_background_color",new t([m,f],null)),240:new r(240,"schannel_iterate",new t([v,new _(f,!1,!0,!1)],new _(v,!1,!0,!0))),241:new r(241,"schannel_get_rock",new t([v],new _(f,!1,!0,!0))),242:new r(242,"schannel_create",new t([f],new _(v,!1,!0,!0))),243:new r(243,"schannel_destroy",new t([v],null)),244:new r(244,"schannel_create_ext",new t([f,f],new _(v,!1,!0,!0))),247:new r(247,"schannel_play_multi",new t([new o(v,!1,!0,!1,!0),new o(f,!1,!0,!1,!0),f],new _(f,!1,!0,!0))),248:new r(248,"schannel_play",new t([v,f],new _(f,!1,!0,!0))),249:new r(249,"schannel_play_ext",new t([v,f,f,f],new _(f,!1,!0,!0))),250:new r(250,"schannel_stop",new t([v],null)),251:new r(251,"schannel_set_volume",new t([v,f],null)),252:new r(252,"sound_load_hint",new t([f,f],null)),253:new r(253,"schannel_set_volume_ext",new t([v,f,f,f],null)),254:new r(254,"schannel_pause",new t([v],null)),255:new r(255,"schannel_unpause",new t([v],null)),256:new r(256,"set_hyperlink",new t([f],null)),257:new r(257,"set_hyperlink_stream",new t([y,f],null)),258:new r(258,"request_hyperlink_event",new t([m],null)),259:new r(259,"cancel_hyperlink_event",new t([m],null)),288:new r(288,"buffer_to_lower_case_uni",new t([new o(f,!1,!0,!0,!0),f],new _(f,!1,!0,!0))),289:new r(289,"buffer_to_upper_case_uni",new t([new o(f,!1,!0,!0,!0),f],new _(f,!1,!0,!0))),290:new r(290,"buffer_to_title_case_uni",new t([new o(f,!1,!0,!0,!0),f,f],new _(f,!1,!0,!0))),291:new r(291,"buffer_canon_decompose_uni",new t([new o(f,!1,!0,!0,!0),f],new _(f,!1,!0,!0))),292:new r(292,"buffer_canon_normalize_uni",new t([new o(f,!1,!0,!0,!0),f],new _(f,!1,!0,!0))),296:new r(296,"put_char_uni",new t([f],null)),297:new r(297,"put_string_uni",new t([new l],null)),298:new r(298,"put_buffer_uni",new t([new o(f,!1,!0,!1,!0)],null)),299:new r(299,"put_char_stream_uni",new t([y,f],null)),300:new r(300,"put_string_stream_uni",new t([y,new l],null)),301:new r(301,"put_buffer_stream_uni",new t([y,new o(f,!1,!0,!1,!0)],null)),304:new r(304,"get_char_stream_uni",new t([y],new _(g,!1,!0,!0))),305:new r(305,"get_buffer_stream_uni",new t([y,new o(f,!1,!1,!0,!0)],new _(f,!1,!0,!0))),306:new r(306,"get_line_stream_uni",new t([y,new o(f,!1,!1,!0,!0)],new _(f,!1,!0,!0))),312:new r(312,"stream_open_file_uni",new t([k,f,f],new _(y,!1,!0,!0))),313:new r(313,"stream_open_memory_uni",new t([new o(f,!0,!0,!0,!1),f,f],new _(y,!1,!0,!0))),314:new r(314,"stream_open_resource_uni",new t([f,f],new _(y,!1,!0,!0))),320:new r(320,"request_char_event_uni",new t([m],null)),321:new r(321,"request_line_event_uni",new t([m,new o(f,!0,!0,!0,!0),f],null)),336:new r(336,"set_echo_line_event",new t([m,f],null)),337:new r(337,"set_terminators_line_event",new t([m,new o(f,!1,!0,!1,!1)],null)),352:new r(352,"current_time",new t([new _(new u(new t([g,f,g],null)),!1,!0,!0)],null)),353:new r(353,"current_simple_time",new t([f],new _(g,!1,!0,!0))),360:new r(360,"time_to_date_utc",new t([new _(new u(new t([g,f,g],null)),!0,!1,!0),new _(new u(new t([g,g,g,g,g,g,g,g],null)),!1,!0,!0)],null)),361:new r(361,"time_to_date_local",new t([new _(new u(new t([g,f,g],null)),!0,!1,!0),new _(new u(new t([g,g,g,g,g,g,g,g],null)),!1,!0,!0)],null)),362:new r(362,"simple_time_to_date_utc",new t([g,f,new _(new u(new t([g,g,g,g,g,g,g,g],null)),!1,!0,!0)],null)),363:new r(363,"simple_time_to_date_local",new t([g,f,new _(new u(new t([g,g,g,g,g,g,g,g],null)),!1,!0,!0)],null)),364:new r(364,"date_to_time_utc",new t([new _(new u(new t([g,g,g,g,g,g,g,g],null)),!0,!1,!0),new _(new u(new t([g,f,g],null)),!1,!0,!0)],null)),365:new r(365,"date_to_time_local",new t([new _(new u(new t([g,g,g,g,g,g,g,g],null)),!0,!1,!0),new _(new u(new t([g,f,g],null)),!1,!0,!0)],null)),366:new r(366,"date_to_simple_time_utc",new t([new _(new u(new t([g,g,g,g,g,g,g,g],null)),!0,!1,!0),f],new _(g,!1,!0,!0))),367:new r(367,"date_to_simple_time_local",new t([new _(new u(new t([g,g,g,g,g,g,g,g],null)),!0,!1,!0),f],new _(g,!1,!0,!0))),4352:new r(4352,"garglk_set_zcolors",new t([f,f],null)),4353:new r(4353,"garglk_set_zcolors_stream",new t([y,f,f],null)),4354:new r(4354,"garglk_set_reversevideo",new t([f],null)),4355:new r(4355,"garglk_set_reversevideo_stream",new t([y,f],null))};function x(e,n,r){return e instanceof i?n?e.signed?r+" & 0xFFFFFFFF":r:"0":e instanceof s?n?e.signed?"self.cast_signed_char("+r+")":r+" & 0xFF":"0":e instanceof a?n?'self.class_obj_from_id("'+e.name+'", '+r+")":"null":"???"}function j(e,n){return e instanceof i?n+" >>> 0":e instanceof s?e.signed?"self.uncast_signed_char("+n+")":n+" & 0xFF":e instanceof a?'self.class_obj_to_id("'+e.name+'", '+n+")":"???"}function M(e){return 128&(e&=255)&&(e+=4294967040),e}function E(e,n){return n?n.disprock:0}function F(e,n){return 0!=n&&n?q[e][n]:null}e.arg_int_unsigned=f,e.arg_int_signed=g,e.arg_char_unsigned=h,e.arg_char_native=d,e.arg_char_signed=p,e.cast_signed_char=function(e){return 128&(e&=255)&&(e-=256),e},e.uncast_signed_char=M,e.class_obj_to_id=E,e.class_obj_from_id=F;var z={};var V=null,W=null,S=-1;e.set_blocked_selector=function(e,n){V=e,W=n.slice(0)};var A=[];e.temp_arg_arrays=A;var R=[];e.retained_arrays=R,e.make_arg_array=function(e,n,r,t){var w;e&&(w={arr:e,addr:n,len:r,arg:t},A.push(w))};var G,q={};return function(){var e,r;for(e in G=1+Math.round(1e3*Math.random()),n)r=n[e],q[r]={}}(),{set_vm:function(n){e.VM=n},get_function:function(n){var r,t=z[n];if(void 0===t){if(void 0===(r=b[n]))throw new Error("dispatch: unknown Glk function: "+n);t=function(n){var r,t,c,f,g,h,d,p,m,y,k,v,b,M,E=[],F={},z=0;for(E.push("// no local vars"),E.push("// "+n.id+": "+n.name),f=null,(c=n.proto).retarg&&(f=c.retarg.arg),E.push("var self = this;"),M=Glk.call_may_not_return(n.id),g=0,h=[],r=0;r<c.args.length;r++)if(p=c.args[r],y="glka"+r,h.push(y),F[y]=!0,p instanceof i||p instanceof s||p instanceof a)k=x(p,!0,"callargs["+g+"]"),E.push(y+" = "+k+";"),g+=1;else if(p instanceof _){if(m=p.arg,E.push("if (callargs["+g+"] == 0) {"),p.nonnull?E.push('  throw new Error("glk '+n.name+': null argument");'):E.push("  "+y+" = null;"),E.push("} else {"),m instanceof i||m instanceof s||m instanceof a)E.push("  "+y+" = new Glk.RefBox();"),k=x(m,p.passin,"self.VM.ReadWord(callargs["+g+"])"),E.push("  "+y+".set_value("+k+");");else{if(!(m instanceof u))throw new Error("buildfunc: unsupported refarg type: "+n.name);for(d=m.form.args,E.push("  "+y+" = new Glk.RefStruct("+d.length+");"),t=0;t<d.length;t++)k=x(d[t],p.passin,"self.VM.ReadStructField(callargs["+g+"], "+t+")"),E.push("  "+y+".push_field("+k+");")}E.push("}"),g+=1}else if(p instanceof o)F.glklen=!0,m=p.arg,E.push("if (callargs["+g+"] == 0) {"),p.nonnull?E.push('  throw new Error("glk '+n.name+': null argument");'):E.push("  "+y+" = null;"),E.push("} else {"),E.push("  glklen = callargs["+(g+1)+"];"),E.push("  "+y+" = Array(glklen);"),p.passin&&(F.ix=!0,F.jx=!0,E.push("  for (ix=0, jx=callargs["+g+"]; ix<glklen; ix++, jx+="+m.refsize+") {"),k=x(m,!0,"self.VM.Read"+m.macro+"(jx)"),E.push("    "+y+"[ix] = "+k+";"),E.push("  }")),p.retained&&(0==z&&E.push("  self.temp_arg_arrays.length = 0;"),z+=1,E.push("  self.make_arg_array("+y+", callargs["+g+"], glklen, self."+m.literal+");")),E.push("}"),g+=2;else{if(!(p instanceof w||p instanceof l))throw new Error("buildfunc: unsupported arg type: "+n.name);var V,W;F.ix=!0,F.jx=!0,p instanceof w?(W="0xE0",V="byte_array_to_string"):(W="0xE2",V="uni_array_to_string"),E.push(y+" = Array();"),E.push("jx = callargs["+g+"];"),E.push("if (self.VM.ReadByte(jx) != "+W+') throw new Error("glk '+n.name+': string argument must be unencoded");'),E.push("for (jx+="+p.refsize+"; true; jx+="+p.refsize+") {"),E.push("  ix = self.VM.Read"+p.macro+"(jx);"),E.push("  if (ix == 0) break;"),E.push("  "+y+".push(ix);"),E.push("}"),E.push(y+" = Glk."+V+"("+y+");"),g+=1}for(E.push("if (callargs.length != "+g+') throw "glk '+n.name+': wrong number of arguments";'),f||M?(F.glkret=!0,v="glkret = "):v="",E.push(v+("Glk.glk_"+n.name).replace("glk_gar","gar")+"("+h.join(", ")+");"),console.log(E),M&&(E.push("if (glkret === Glk.DidNotReturn) {"),E.push("  self.set_blocked_selector("+n.id+", callargs);"),E.push("  return glkret;"),E.push("}")),g=0,r=0;r<c.args.length;r++)if(y="glka"+r,(p=c.args[r])instanceof i||p instanceof s||p instanceof a)g+=1;else if(p instanceof _){if(m=p.arg,p.passout){if(E.push("if ("+y+") {"),m instanceof i||m instanceof s||m instanceof a)k=j(m,y+".get_value()"),E.push("  self.VM.WriteWord(callargs["+g+"], "+k+");");else{if(!(m instanceof u))throw new Error("buildfunc: unsupported refarg type: "+n.name);for(d=m.form.args,t=0;t<d.length;t++)k=j(d[t],y+".get_field("+t+")"),E.push("  self.VM.WriteStructField(callargs["+g+"], "+t+", "+k+");")}E.push("}")}g+=1}else if(p instanceof o)m=p.arg,p.passout&&!p.retained&&(E.push("if ("+y+") {"),F.ix=!0,F.jx=!0,E.push("  for (ix=0, jx=callargs["+g+"]; ix<glklen; ix++, jx+="+m.refsize+") {"),k=j(m,y+"[ix]"),E.push("    self.VM.Write"+m.macro+"(jx, "+k+")"),E.push("  }"),E.push("}")),g+=2;else{if(!(p instanceof w||p instanceof l))throw new Error("buildfunc: unsupported arg type: "+n.name);g+=1}for(k in 0!=z&&E.push("self.temp_arg_arrays.length = 0;"),f?(k=j(f,"glkret"),E.push("return "+k+";")):E.push("return 0;"),b=[],F)b.push(k);return b.length&&(E[0]="var "+b.join(", ")+";"),k=E.join("\n"),new Function("callargs",k).bind(e)}(r),z[n]=t}return t},prepare_resume:function(n){192==V?0!=W[0]&&(S=n.get_field(0)>>>0,e.VM.WriteStructField(W[0],0,n.get_field(0)>>>0),e.VM.WriteStructField(W[0],1,E(0,n.get_field(1))),e.VM.WriteStructField(W[0],2,n.get_field(2)>>>0),e.VM.WriteStructField(W[0],3,n.get_field(3)>>>0)):98==V&&e.VM.SetResumeStore(E(0,n)),V=null,W=null},check_autosave:function(){return 192==V&&W&&W.length>0&&(2==S||3==S||4==S||8==S)?W[0]:null},class_register:function(e,n,r){if(void 0===r){if(n.disprock)throw new Error("class_register: object is already registered");n.disprock=G,G++}else{if(n.disprock!=r)throw new Error("class_register: object is not already registered");G<=r&&(G=r+1)}q[e][n.disprock]=n},class_unregister:function(e,n){if(!n.disprock||void 0===q[e][n.disprock])throw new Error("class_unregister: object is not registered");delete q[e][n.disprock],n.disprock=void 0},class_obj_to_id:E,class_obj_from_id:F,retain_array:function(e,n){var r,t;if(e){if(void 0!==n){if(e!==n.arr)throw new Error("retain_array: array does not match useobj");if((t={addr:n.addr,len:n.len,arr:e,arg:c(n.arg)}).len!=e.length)throw new Error("retain_array: array length from useobj does not match")}else for(t=void 0,r=0;r<A.length;r++)if(A[r].arr===e){t=A[r];break}if(void 0===t)throw new Error("retain_array: array is not an argument");for(r=0;void 0!==R[r];r++);R[r]=t}},unretain_array:function(n){var r,t,w;if(n){for(w=void 0,r=0;r<R.length;r++)if(void 0!==R[r]&&R[r].arr===n){w=R[r],delete R[r];break}if(void 0===w)throw new Error("unretain_array: array was never retained");if(w.arg instanceof i)for(r=0,t=w.addr;r<w.len;r++,t+=4)e.VM.WriteWord(t,w.arr[r]>>>0);else{if(!(w.arg instanceof s))throw new Error("unretain_array: unsupported refarg type");if(w.arg.signed)for(r=0,t=w.addr;r<w.len;r++,t++)e.VM.WriteByte(t,M(w.arr[r]));else for(r=0,t=w.addr;r<w.len;r++,t++)e.VM.WriteByte(t,255&w.arr[r])}}},get_retained_array:function(e){var n;for(n=0;n<R.length;n++)if(void 0!==R[n]&&R[n].arr===e)return R[n];return null}}}();