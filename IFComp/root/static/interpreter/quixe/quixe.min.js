var Quixe=function(){var e={};function s(e){if("string"==typeof e)return e;var s=e.toString();return e.message&&(s=s+" "+e.message),e.fileName&&(s=s+" "+e.fileName),e.lineNumber&&(s=s+" line:"+e.lineNumber),e.name&&(s=s+" "+e.name),e.number&&(s=s+" "+e.number),s}function r(e){window.console&&console.log?console.log(e):window.opera&&opera.postError&&opera.postError(e)}function a(){if(ye&&ye.length){var e,s,a,t,o=[];for(e=0;e<ye.length;e++)(t=ye[e]).vmfunc.funcaddr?(s="0x"+t.vmfunc.funcaddr.toString(16),(a=fs.functionmap[t.vmfunc.funcaddr])&&(s=s+' "'+a.name+'"'),o.push(s)):o.push("(anonymous)");r("VM stack dump: "+o.join(", "))}}void 0===Math.imul&&(r("Polyfilling Math.imul()."),Math.imul=function(e,s){var r=65535&e,a=65535&s;return r*a+((e>>>16&65535)*a+r*(s>>>16&65535)<<16>>>0)|0});var t=Array(256),o=Array(256);function n(e,s){return 16777216*e[s]+65536*e[s+1]+256*e[s+2]+e[s+3]}function f(e,s){return 256*e[s]+e[s+1]}function c(e,s){return e[s]}function u(e){return xe[e]}function l(e){return 256*xe[e]+xe[e+1]}function i(e){return 16777216*xe[e]+65536*xe[e+1]+256*xe[e+2]+xe[e+3]}function d(e,s){return xe.slice(e,e+s)}function p(e,s){xe[e]=255&s}function h(e,s){xe[e]=s>>8&255,xe[e+1]=255&s}function m(e,s){xe[e]=s>>24&255,xe[e+1]=s>>16&255,xe[e+2]=s>>8&255,xe[e+3]=255&s}function v(e,s){for(var r=0;r<s.length;r++)e.push(s.charCodeAt(r))}function g(e,s){e.push(s>>24&255),e.push(s>>16&255),e.push(s>>8&255),e.push(255&s)}function k(e,s){e.push(s>>8&255),e.push(255&s)}function _(e,s){e.push(255&s)}function b(e,s,r){return String.fromCharCode.apply(this,e.slice(s,s+r))}function x(e){return xe[e]>=128?"0xffffff"+t[xe[e]]:"0x"+t[xe[e]]}function y(e){return xe[e]>=128?"0xffff"+t[xe[e]]+t[xe[e+1]]:xe[e]?"0x"+t[xe[e]]+t[xe[e+1]]:"0x"+t[xe[e+1]]}function w(e){return xe[e]?"0x"+t[xe[e]]+t[xe[e+1]]+t[xe[e+2]]+t[xe[e+3]]:xe[e+1]?"0x"+t[xe[e+1]]+t[xe[e+2]]+t[xe[e+3]]:xe[e+2]?"0x"+t[xe[e+2]]+t[xe[e+3]]:"0x"+t[xe[e+3]]}function M(e){return e<65536?String.fromCharCode(e):(e-=65536,String.fromCharCode(55296+(e>>10),56320+(1023&e)))}function z(e){return function(e){if(e<256)return o[e];if(e<65536){for(e=e.toString(16);e.length<4;)e="0"+e;return"\\u"+e}var s;return s=55296+((e-=65536)>>10),e=56320+(1023&e),"\\u"+s.toString(16)+"\\u"+e.toString(16)}(e.charCodeAt(0))}e.Mem1=u,e.Mem2=l,e.Mem4=i,e.MemSlice=d,e.MemW1=p,e.MemW2=h,e.MemW4=m;var S=/[^a-zA-Z0-9 .,;:?!=_+()-]/g;function N(e){return'"'+(e=e.replace(S,z))+'"'}function C(e){var s,a;if(arguments.length>1){for(e+=" (",s=1;s<arguments.length;s++)1!=s&&(e+=" "),e+=a="number"==typeof(a=arguments[s])?a.toString(16):""+a;e+=")"}throw r(e),new Error(e)}function L(e,s,r,a){return void 0===s&&(s="_func"),void 0===r?new Function("self",e):void 0===a?new Function("self",r,e):new Function("self",r,a,e)}function F(e,s,r,a){var t,o;e?(this.funcaddr=e,this.startpc=s,this.functype=u(e)):(this.funcaddr=null,this.startpc=null,this.functype=null),this.pathaddrs={},this[0]={},this[1]={},this[2]={},this.locallen=null,this.localsformat=r,this.rawformat=a,this.localsindex=[];var n=0;for(t=0;t<this.localsformat.length;t++){var f=this.localsformat[t];if(4==f.size)for(;3&n;)n++;else if(2==f.size)for(;1&n;)n++;for(o=0;o<f.count;o++)this.localsindex.push({size:f.size,pos:n}),n+=f.size}for(;3&n;)n++;this.locallen=n}function G(e){var s;for(this.vmfunc=e,this.depth=null,this.framestart=null,this.framelen=null,this.valstack=[],this.localspos=null,this.localsindex=e.localsindex,this.locals=[],s=0;s<this.localsindex.length;s++){var r=this.localsindex[s];this.locals[r.pos]=0}this.framelen=8+e.rawformat.length+e.locallen}function j(e,s){g(s,e.framelen);var r=e.vmfunc.rawformat;g(s,8+r.length);for(var a=0;a<r.length;a++)s.push(r[a]);for(a=0;a<e.vmfunc.localsindex.length;a++){var t=e.vmfunc.localsindex[a];if(4==t.size){for(;3&s.length;)s.push(0);g(s,e.locals[t.pos])}else if(2==t.size){for(;1&s.length;)s.push(0);k(s,e.locals[t.pos])}else _(s,e.locals[t.pos])}for(;3&s.length;)s.push(0);for(a=0;a<e.valstack.length;a++)g(s,e.valstack[a])}function q(e){var s=n(e,e.length-4);if(!(s<0||s>=e.length)){for(var a=n(e=e.splice(s,e.length),0),t=n(e,4),o=e.slice(8,t),u=[],l=8;;){var i=c(e,l),d=c(e,++l);if(l++,0==i)break;1!=i&&2!=i&&4!=i&&C("Invalid local variable size in function header.",i),u.push({size:i,count:d})}var p=new G(new F(null,null,u,o));p.framestart=s;for(var h=0;h<p.vmfunc.localsindex.length;h++){var m=p.vmfunc.localsindex[h];4==m.size?p.locals[m.pos]=n(e,t+m.pos):2==m.size?p.locals[m.pos]=f(e,t+m.pos):p.locals[m.pos]=c(e,t+m.pos)}for(var v=a;v<e.length;v+=4)p.valstack.push(n(e,v));return p}r("Bad frameptr in serialized stack frame")}function A(e,s){0==e&&C("Tried to create a VMTextEnv for address zero."),this.addr=e,this.cacheable=void 0!==s,this.decoding_tree=s,this.vmstring_tables=[],this.cacheable&&(this.vmstring_tables[0]={},this.vmstring_tables[1]={},this.vmstring_tables[2]={})}e.fatal_error=C;var W=null;function E(e,s,r){var a;switch(s.mode){case 8:if(4==s.argsize){if("0"===(t=r[0]))return e.offstack.push(r),void e.code.push("// push to offstack: "+r);if("_"===t)return function(e,s){e.offstack.push(s);var r=e.holduse[s];r&&!0!==r?r++:r=1;e.holduse[s]=r}(e,r),void e.code.push("// re-push to offstack: "+r)}return a=O(e,!0),e.offstack.push(a),void(4==s.argsize?e.code.push(a+"=("+r+");"):2==s.argsize?e.code.push(a+"=0xffff&("+r+");"):e.code.push(a+"=0xff&("+r+");"));case 0:return void e.code.push("("+r+");");case 11:if(4==s.argsize){var t;if("0"===(t=r[0]))return B(e,s.addr,r,!1),void e.code.push("// store to offloc["+s.addr+"]: "+r);if("_"===t)return B(e,s.addr,r,!0),void e.code.push("// re-store to offloc["+s.addr+"]: "+r)}return B(e,s.addr,void 0),void(4==s.argsize?e.code.push("self.frame.locals["+s.addr+"]=("+r+");"):2==s.argsize?e.code.push("self.frame.locals["+s.addr+"]=(0xffff &"+r+");"):e.code.push("self.frame.locals["+s.addr+"]=(0xff &"+r+");"));case 15:return void(4==s.argsize?e.code.push("self.MemW4("+s.addr+","+r+");"):2==s.argsize?e.code.push("self.MemW2("+s.addr+","+r+");"):e.code.push("self.MemW1("+s.addr+","+r+");"));default:C("Unknown addressing mode in store func operand.")}}function D(e,s,r){void 0===r&&(r=e.cp),e.code.push("self.frame.valstack.push("+s+","+r+",self.frame.framestart);")}function U(e){e.code.push("if (!substring) { substring=true;"),e.code.push("self.frame.valstack.push(0x11,0,nextcp,self.frame.framestart);"),e.code.push("}")}function I(e,s){var r;if(e.code.push("// unload offstate: "+e.offstack.length+" stack"+(e.offloc.length?", plus locs":"")+(s?" (conditional)":"")),e.offstack.length&&e.code.push("self.frame.valstack.push("+e.offstack.join(",")+");"),e.offloc.length)for(r=0;r<e.offloc.length;r++)void 0!==e.offloc[r]&&e.offlocdirty[r]&&e.code.push("self.frame.locals["+r+"]="+e.offloc[r]+";");if(!s){var a;for(r=0;r<e.offloc.length;r++)void 0!==(a=e.offloc[r])&&void 0!==e.holduse[a]&&(e.holduse[a]=!1);for(e.offloc.length=0,e.offlocdirty.length=0;e.offstack.length;)a=e.offstack.pop(),void 0!==e.holduse[a]&&(e.holduse[a]=!1)}}function T(e){if(0!=e.buffer.length){var s=e.buffer.join("");e.buffer.length=0,e.code.push("Glk.glk_put_jstring("+N(s)+");")}}function P(e,s,r){var a;if(Z(s))return 2147483648&(a=Number(s))?""+(a-4294967296):s;if(a="("+s+"&0xffffffff)",r){var t=O(e);return e.code.push(t+"="+a+";"),t}return a}function V(e,s,r){var a;if(Z(s))return 2147483648==(a=Number(s))?"-0":""+_e(a);if(a="self.decode_float("+s+")",r){var t=O(e);return e.code.push(t+"="+a+";"),t}return a}function R(e,s,r){if(Z(s)){var a=Number(s);if(0==a||1==a)r?(e.code.push("// quashing offstack for unconditional return: "+e.offstack.length),e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0):e.code.push("// ignoring offstack for conditional return: "+e.offstack.length),e.code.push("if (self.leave_function()) return self.VMStopped;"),e.code.push("self.pop_callstub("+a+");");else{I(e,!r);var t=e.cp+a-2>>>0;e.code.push("self.pc = "+t+";"),e.vmfunc.pathaddrs[t]=!0}}else I(e,!r),e.code.push("if (("+s+")==0 || ("+s+")==1) {"),e.code.push("if (self.leave_function()) return self.VMStopped;"),e.code.push("self.pop_callstub("+s+");"),e.code.push("}"),e.code.push("else {"),e.code.push("self.pc = ("+e.cp+"+("+s+")-2) >>>0;"),e.code.push("}");e.code.push("return;")}e.funcop_cache={};var H={0:function(e,s){},16:function(e,s){e.code.push(s[2]+"(("+s[0]+")+("+s[1]+")) >>>0);")},17:function(e,s){e.code.push(s[2]+"(("+s[0]+")-("+s[1]+")) >>>0);")},18:function(e,s){var r=P(e,s[0]),a=P(e,s[1]);e.code.push(s[2]+"(Math.imul(("+r+"),("+a+"))) >>>0);")},19:function(e,s){var r=P(e,s[0]),a=P(e,s[1]),t=O(e);e.code.push(t+"=(("+r+")/("+a+"));"),e.code.push("if (!isFinite("+t+")) self.fatal_error('Division by zero.');"),e.code.push(s[2]+"("+t+">=0)?Math.floor("+t+"):(-Math.floor(-"+t+") >>>0));")},20:function(e,s){var r=P(e,s[0]),a=P(e,s[1]),t=O(e);e.code.push(t+"=(("+r+")%("+a+"));"),e.code.push("if (!isFinite("+t+")) self.fatal_error('Modulo division by zero.');"),e.code.push(s[2]+t+" >>>0);")},21:function(e,s){e.code.push(s[1]+"(-("+s[0]+")) >>>0);")},24:function(e,s){e.code.push(s[2]+"(("+s[0]+")&("+s[1]+")) >>>0);")},25:function(e,s){e.code.push(s[2]+"(("+s[0]+")|("+s[1]+")) >>>0);")},26:function(e,s){e.code.push(s[2]+"(("+s[0]+")^("+s[1]+")) >>>0);")},27:function(e,s){e.code.push(s[1]+"(~("+s[0]+")) >>>0);")},28:function(e,s){if(Z(s[1])){var r=Number(s[1]);r<32?e.code.push(s[2]+"(("+s[0]+")<<"+r+") >>>0);"):e.code.push(s[2]+"0);")}else e.code.push(s[2]+"("+s[1]+"<32) ? (("+s[0]+"<<"+s[1]+") >>>0) : 0);")},29:function(e,s){if(Z(s[1])){var r=Number(s[1]);r<32?e.code.push(s[2]+"(("+s[0]+")>>"+r+") >>>0);"):e.code.push(s[2]+"(("+s[0]+")&0x80000000) ? 0xffffffff : 0);")}else e.code.push("if ("+s[0]+" & 0x80000000) {"),e.code.push(s[2]+"("+s[1]+"<32) ? (("+s[0]+">>"+s[1]+") >>>0) : 0xffffffff);"),e.code.push("} else {"),e.code.push(s[2]+"("+s[1]+"<32) ? (("+s[0]+">>"+s[1]+") >>>0) : 0);"),e.code.push("}")},30:function(e,s){if(Z(s[1])){var r=Number(s[1]);r<32?e.code.push(s[2]+"("+s[0]+")>>>"+r+");"):e.code.push(s[2]+"0);")}else e.code.push(s[2]+"("+s[1]+"<32) ? ("+s[0]+">>>"+s[1]+") : 0);")},32:function(e,s){R(e,s[0],!0),e.path_ends=!0},260:function(e,s){if(Z(s[0])){var r=Number(s[0]);e.code.push("self.pc = "+r+";"),e.vmfunc.pathaddrs[r]=!0}else e.code.push("self.pc = "+s[0]+";");I(e),e.code.push("return;"),e.path_ends=!0},34:function(e,s){e.code.push("if (("+s[0]+")==0) {"),R(e,s[1]),e.code.push("}")},35:function(e,s){e.code.push("if (("+s[0]+")!=0) {"),R(e,s[1]),e.code.push("}")},36:function(e,s){e.code.push("if (("+s[0]+")==("+s[1]+")) {"),R(e,s[2]),e.code.push("}")},37:function(e,s){e.code.push("if (("+s[0]+")!=("+s[1]+")) {"),R(e,s[2]),e.code.push("}")},38:function(e,s){var r=P(e,s[0]),a=P(e,s[1]);e.code.push("if (("+r+")<("+a+")) {"),R(e,s[2]),e.code.push("}")},39:function(e,s){var r=P(e,s[0]),a=P(e,s[1]);e.code.push("if (("+r+")>=("+a+")) {"),R(e,s[2]),e.code.push("}")},40:function(e,s){var r=P(e,s[0]),a=P(e,s[1]);e.code.push("if (("+r+")>("+a+")) {"),R(e,s[2]),e.code.push("}")},41:function(e,s){var r=P(e,s[0]),a=P(e,s[1]);e.code.push("if (("+r+")<=("+a+")) {"),R(e,s[2]),e.code.push("}")},42:function(e,s){e.code.push("if (("+s[0]+")<("+s[1]+")) {"),R(e,s[2]),e.code.push("}")},43:function(e,s){e.code.push("if (("+s[0]+")>=("+s[1]+")) {"),R(e,s[2]),e.code.push("}")},44:function(e,s){e.code.push("if (("+s[0]+")>("+s[1]+")) {"),R(e,s[2]),e.code.push("}")},45:function(e,s){e.code.push("if (("+s[0]+")<=("+s[1]+")) {"),R(e,s[2]),e.code.push("}")},48:function(e,s){if(Z(s[1])){var r,a=Number(s[1]);for(r=0;r<a;r++)if(e.offstack.length){var t=Q(e);e.code.push("self.tempcallargs["+r+"]="+t+";")}else e.code.push("self.tempcallargs["+r+"]=self.frame.valstack.pop();");I(e)}else e.varsused.ix=!0,I(e),e.code.push("for (ix=0; ix<"+s[1]+"; ix++) { self.tempcallargs[ix]=self.frame.valstack.pop(); }");D(e,s[2]),e.code.push("self.enter_function("+s[0]+", "+s[1]+");"),e.code.push("return;"),e.path_ends=!0},52:function(e,s){if(Z(s[1])){var r,a=Number(s[1]);for(r=0;r<a;r++)if(e.offstack.length){var t=Q(e);e.code.push("self.tempcallargs["+r+"]="+t+";")}else e.code.push("self.tempcallargs["+r+"]=self.frame.valstack.pop();");I(e)}else e.varsused.ix=!0,I(e),e.code.push("for (ix=0; ix<"+s[1]+"; ix++) { self.tempcallargs[ix]=self.frame.valstack.pop(); }");e.code.push("if (self.leave_function()) return self.VMStopped;"),e.code.push("self.enter_function("+s[0]+", "+s[1]+");"),e.code.push("return;"),e.path_ends=!0},352:function(e,s){I(e),D(e,s[1]),e.code.push("self.enter_function("+s[0]+", 0);"),e.code.push("return;"),e.path_ends=!0},353:function(e,s){I(e),e.code.push("self.tempcallargs[0]=("+s[1]+");"),D(e,s[2]),e.code.push("self.enter_function("+s[0]+", 1);"),e.code.push("return;"),e.path_ends=!0},354:function(e,s){I(e),e.code.push("self.tempcallargs[0]=("+s[1]+");"),e.code.push("self.tempcallargs[1]=("+s[2]+");"),D(e,s[3]),e.code.push("self.enter_function("+s[0]+", 2);"),e.code.push("return;"),e.path_ends=!0},355:function(e,s){I(e),e.code.push("self.tempcallargs[0]=("+s[1]+");"),e.code.push("self.tempcallargs[1]=("+s[2]+");"),e.code.push("self.tempcallargs[2]=("+s[3]+");"),D(e,s[4]),e.code.push("self.enter_function("+s[0]+", 3);"),e.code.push("return;"),e.path_ends=!0},49:function(e,s){e.code.push("// quashing offstack for return: "+e.offstack.length),e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0,e.code.push("if (self.leave_function()) return self.VMStopped;"),e.code.push("self.pop_callstub("+s[0]+");"),e.code.push("return;"),e.path_ends=!0},50:function(e,s){I(e),D(e,s[0]),e.code.push("self.store_operand("+s[0]+",self.frame.framestart+self.frame.framelen+4*self.frame.valstack.length);"),R(e,s[1],!0),e.path_ends=!0},51:function(e,s){e.code.push("// quashing offstack for throw: "+e.offstack.length),e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0,e.code.push("self.pop_stack_to("+s[1]+");"),e.code.push("self.pop_callstub("+s[0]+");"),e.code.push("return;"),e.path_ends=!0},64:function(e,s){E(e,s[1],s[0])},65:function(e,s){E(e,s[1],s[0])},66:function(e,s){E(e,s[1],s[0])},68:function(e,s){var r;Z(s[0])?(r=32768&(r=Number(s[0]))?(4294901760|r)>>>0:65535&r,e.code.push(s[1]+r+");")):e.code.push(s[1]+"("+s[0]+" & 0x8000) ? (("+s[0]+" | 0xffff0000) >>> 0) : ("+s[0]+" & 0xffff));")},69:function(e,s){var r;Z(s[0])?(r=128&(r=Number(s[0]))?(4294967040|r)>>>0:255&r,e.code.push(s[1]+r+");")):e.code.push(s[1]+"("+s[0]+" & 0x80) ? (("+s[0]+" | 0xffffff00) >>> 0) : ("+s[0]+" & 0xff));")},72:function(e,s){var r,a;Z(s[1])?r=Z(s[0])?"self.Mem4("+((a=Number(s[0])+4*Number(s[1]))>>>0)+")":(a=4*Number(s[1]))?"self.Mem4(("+s[0]+"+"+a+") >>>0)":"self.Mem4("+s[0]+")":r="self.Mem4(("+s[0]+"+4*"+s[1]+") >>>0)";e.code.push(s[2]+r+");")},73:function(e,s){var r,a;Z(s[1])?r=Z(s[0])?"self.Mem2("+((a=Number(s[0])+2*Number(s[1]))>>>0)+")":(a=2*Number(s[1]))?"self.Mem2(("+s[0]+"+"+a+") >>>0)":"self.Mem2("+s[0]+")":r="self.Mem2(("+s[0]+"+2*"+s[1]+") >>>0)";e.code.push(s[2]+r+");")},74:function(e,s){var r,a;Z(s[1])?r=Z(s[0])?"self.Mem1("+((a=Number(s[0])+Number(s[1]))>>>0)+")":(a=Number(s[1]))?"self.Mem1(("+s[0]+"+"+a+") >>>0)":"self.Mem1("+s[0]+")":r="self.Mem1(("+s[0]+"+"+s[1]+") >>>0)";e.code.push(s[2]+r+");")},76:function(e,s){var r,a;Z(s[1])?r=Z(s[0])?((a=Number(s[0])+4*Number(s[1]))>>>0)+",":(a=4*Number(s[1]))?"("+s[0]+"+"+a+") >>>0,":s[0]+",":r="("+s[0]+"+4*"+s[1]+") >>>0,";e.code.push("self.MemW4("+r+s[2]+");")},77:function(e,s){var r,a;Z(s[1])?r=Z(s[0])?((a=Number(s[0])+2*Number(s[1]))>>>0)+",":(a=2*Number(s[1]))?"("+s[0]+"+"+a+") >>>0,":s[0]+",":r="("+s[0]+"+2*"+s[1]+") >>>0,";e.code.push("self.MemW2("+r+s[2]+");")},78:function(e,s){var r,a;Z(s[1])?r=Z(s[0])?((a=Number(s[0])+Number(s[1]))>>>0)+",":(a=Number(s[1]))?"("+s[0]+"+"+a+") >>>0,":s[0]+",":r="("+s[0]+"+"+s[1]+") >>>0,";e.code.push("self.MemW1("+r+s[2]+");")},75:function(e,s){if(Z(s[1])){var r,a,t;r=7&(t=4294967295&Number(s[1])),Z(s[0])?(a=Number(s[0]),t>=0?a+=t>>3:a-=1+(-1-t>>3)):a=t>=0?t<=7?s[0]:s[0]+"+"+(t>>3):s[0]+"-"+(1+(-1-t>>3)),e.code.push(s[2]+"(self.Mem1("+a+") & "+(1<<r)+")?1:0);")}else{e.varsused.bitx=!0,e.varsused.addrx=!0;var o=P(e,s[1],!0);e.code.push("bitx = "+o+"&7;"),e.code.push("if ("+o+">=0) addrx = "+s[0]+" + ("+o+">>3);"),e.code.push("else addrx = "+s[0]+" - (1+((-1-("+o+"))>>3));"),e.code.push(s[2]+"(self.Mem1(addrx) & (1<<bitx))?1:0);")}},79:function(e,s){var r,a,t,o;if(Z(s[1]))r=7&(o=4294967295&Number(s[1])),Z(s[0])?(a=Number(s[0]),o>=0?a+=o>>3:a-=1+(-1-o>>3)):a=o>=0?o<=7?s[0]:s[0]+"+"+(o>>3):s[0]+"-"+(1+(-1-o>>3)),t=1<<r;else{e.varsused.bitx=!0,e.varsused.addrx=!0;var n=P(e,s[1],!0);e.code.push("bitx = "+n+"&7;"),e.code.push("if ("+n+">=0) addrx = "+s[0]+" + ("+n+">>3);"),e.code.push("else addrx = "+s[0]+" - (1+((-1-("+n+"))>>3));"),a="addrx",t="(1<<bitx)"}Z(s[2])?Number(s[2])?e.code.push("self.MemW1("+a+", self.Mem1("+a+") | "+t+");"):e.code.push("self.MemW1("+a+", self.Mem1("+a+") & ~("+t+"));"):(e.code.push("if ("+s[2]+") self.MemW1("+a+", self.Mem1("+a+") | "+t+");"),e.code.push("else self.MemW1("+a+", self.Mem1("+a+") & ~("+t+"));"))},80:function(e,s){var r,a=e.offstack.length;r=a?"self.frame.valstack.length+"+a:"self.frame.valstack.length",E(e,s[0],r)},81:function(e,s){var r;if(Z(s[0])){var a=Number(s[0]);r=a<e.offstack.length?e.offstack[e.offstack.length-(a+1)]:"self.frame.valstack[self.frame.valstack.length-"+(a+1-e.offstack.length)+"]"}else I(e),r="self.frame.valstack[self.frame.valstack.length-("+s[0]+"+1)]";E(e,s[1],r)},82:function(e,s){var r,a;e.offstack.length<2&&function(e,s){var r;for(;e.offstack.length<s;)r=O(e,!0),e.offstack.unshift(r),e.code.push(r+"=self.frame.valstack.pop();")}(e,2),a=e.offstack.length,r=e.offstack[a-1],e.offstack[a-1]=e.offstack[a-2],e.offstack[a-2]=r},83:function(e,s){I(e),e.varsused.ix=!0,e.varsused.pos=!0,e.varsused.roll=!0,e.varsused.vals1=!0;var r=P(e,s[0],!0),a=P(e,s[1],!0);e.code.push("if ("+r+" > 0) {"),e.code.push("if ("+a+" > 0) {"),e.code.push("vals1 = "+a+" % "+r+";"),e.code.push("} else {"),e.code.push("vals1 = "+r+" - (-("+a+")) % "+r+";"),e.code.push("}"),e.code.push("if (vals1) {"),e.code.push("pos = self.frame.valstack.length - "+r+";"),e.code.push("roll = self.frame.valstack.slice(self.frame.valstack.length-vals1, self.frame.valstack.length).concat(self.frame.valstack.slice(pos, self.frame.valstack.length-vals1));"),e.code.push("for (ix=0; ix<"+r+"; ix++) { self.frame.valstack[pos+ix] = roll[ix]; }"),e.code.push("roll = undefined;"),e.code.push("}"),e.code.push("}")},84:function(e,s){if(I(e),Z(s[0])){var r,a,t=Number(s[0]);for(r=0;r<t;r++)a=O(e,!0),e.offstack.push(a),e.code.push(a+"=self.frame.valstack[self.frame.valstack.length-"+(t-r)+"];")}else e.varsused.ix=!0,e.varsused.jx=!0,e.code.push("jx = self.frame.valstack.length-("+s[0]+");"),e.code.push("for (ix=0; ix<"+s[0]+"; ix++) { self.frame.valstack.push(self.frame.valstack[jx+ix]); }")},256:function(e,s){var r="self.do_gestalt(("+s[0]+"),("+s[1]+"))";e.code.push(s[2]+r+");")},257:function(e,s){e.code.push("self.fatal_error('User debugtrap encountered.', "+s[0]+");")},258:function(e,s){e.code.push(s[0]+"self.endmem);")},259:function(e,s){e.code.push("self.change_memsize("+s[0]+",false);"),e.code.push(s[1]+"0);")},272:function(e,s){var r;if(Z(s[0])){var a=4294967295&Number(s[0]);r=0==a?"(Math.floor(self.random_func() * 0x10000) | (Math.floor(self.random_func() * 0x10000) << 16)) >>>0":a>0?"Math.floor(self.random_func() * "+a+")":"-Math.floor(self.random_func() * "+-a+")"}else{var t=P(e,s[0],!0),o=O(e);r=o,e.code.push("if ("+t+" > 0)"),e.code.push(o+" = Math.floor(self.random_func() * "+t+");"),e.code.push("else if ("+t+" < 0)"),e.code.push(o+" = -Math.floor(self.random_func() * -"+t+");"),e.code.push("else"),e.code.push(o+" = (Math.floor(self.random_func() * 0x10000) | (Math.floor(self.random_func() * 0x10000) << 16)) >>>0;")}e.code.push(s[1]+r+");")},273:function(e,s){e.code.push("self.set_random("+s[0]+");")},288:function(e,s){e.code.push("// quashing offstack for quit: "+e.offstack.length),e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0,e.code.push("return self.VMStopped;"),e.path_ends=!0},289:function(e,s){e.code.push(s[0]+"self.perform_verify());")},290:function(e,s){e.code.push("// quashing offstack for quit: "+e.offstack.length),e.offstack.length=0,e.offloc.length=0,e.offlocdirty.length=0,e.code.push("self.vm_restart();"),e.code.push("return;"),e.path_ends=!0},291:function(e,s){I(e),e.varsused.ix=!0,D(e,s[1]),e.code.push("ix = self.vm_save("+s[0]+");"),e.code.push("self.pop_callstub(ix ? 0 : 1);"),e.code.push("return;"),e.path_ends=!0},292:function(e,s){I(e),e.code.push("if (self.vm_restore("+s[0]+")) {"),e.code.push("self.pop_callstub((-1)>>>0);"),e.code.push("} else {"),E(e,s[1],"1"),I(e),e.code.push("self.pc = "+e.cp+";"),e.code.push("}"),e.code.push("return;"),e.path_ends=!0},293:function(e,s){I(e),D(e,s[0]),e.code.push("self.vm_saveundo();"),e.code.push("self.pop_callstub(0);"),e.code.push("return;"),e.path_ends=!0},294:function(e,s){I(e),e.code.push("if (self.vm_restoreundo()) {"),e.code.push("self.pop_callstub((-1)>>>0);"),e.code.push("} else {"),E(e,s[0],"1"),I(e),e.code.push("self.pc = "+e.cp+";"),e.code.push("}"),e.code.push("return;"),e.path_ends=!0},295:function(e,s){e.code.push("self.protectstart="+s[0]+";"),e.code.push("self.protectend=self.protectstart+("+s[1]+");"),e.code.push("if (self.protectstart==self.protectend) {"),e.code.push("  self.protectstart=0; self.protectend=0;"),e.code.push("}")},368:function(e,s){e.varsused.maddr=!0,e.varsused.mlen=!0,e.varsused.ix=!0,e.code.push("mlen="+s[0]+";"),e.code.push("maddr="+s[1]+";"),e.code.push("for (ix=0; ix<mlen; ix++, maddr++) self.MemW1(maddr, 0);")},369:function(e,s){e.varsused.msrc=!0,e.varsused.mdest=!0,e.varsused.mlen=!0,e.varsused.ix=!0,e.code.push("mlen="+s[0]+";"),e.code.push("msrc="+s[1]+";"),e.code.push("mdest="+s[2]+";"),e.code.push("if (mdest < msrc) {"),e.code.push("for (ix=0; ix<mlen; ix++, msrc++, mdest++) self.MemW1(mdest, self.Mem1(msrc));"),e.code.push("} else {"),e.code.push("msrc += (mlen-1); mdest += (mlen-1);"),e.code.push("for (ix=0; ix<mlen; ix++, msrc--, mdest--) self.MemW1(mdest, self.Mem1(msrc));"),e.code.push("}")},376:function(e,s){var r="self.heap_malloc("+s[0]+")";e.code.push(s[1]+r+");"),e.code.push("self.assert_heap_valid();")},377:function(e,s){e.code.push("self.heap_free("+s[0]+");"),e.code.push("self.assert_heap_valid();")},384:function(e,s){e.code.push("self.accel_funcnum_map["+s[1]+"] = "+s[0]+";"),e.code.push("self.accel_address_map["+s[1]+"] = self.accel_func_map["+s[0]+"];")},385:function(e,s){e.code.push("if ("+s[0]+" < 9) {"),e.code.push("  self.accel_params["+s[0]+"] = "+s[1]+";"),e.code.push("}")},336:function(e,s){var r="self.linear_search(("+s[0]+"),("+s[1]+"),("+s[2]+"),("+s[3]+"),("+s[4]+"),("+s[5]+"),("+s[6]+"))";e.code.push(s[7]+r+");")},337:function(e,s){var r="self.binary_search(("+s[0]+"),("+s[1]+"),("+s[2]+"),("+s[3]+"),("+s[4]+"),("+s[5]+"),("+s[6]+"))";e.code.push(s[7]+r+");")},338:function(e,s){var r="self.linked_search(("+s[0]+"),("+s[1]+"),("+s[2]+"),("+s[3]+"),("+s[4]+"),("+s[5]+"))";e.code.push(s[6]+r+");")},112:function(e,s){switch(e.curiosys){case 2:if(Z(s[0])){var r=255&Number(s[0]);e.code.push("Glk.glk_put_char("+r+");")}else e.code.push("Glk.glk_put_char(("+s[0]+")&0xff);");break;case 1:I(e),e.code.push("self.tempcallargs[0]=(("+s[0]+")&0xff);"),D(e,"0,0"),e.code.push("self.enter_function(self.iosysrock, 1);"),e.code.push("return;"),e.path_ends=!0;break;case 0:e.code.push("// null streamchar "+s[0])}},113:function(e,s){switch(e.curiosys){case 2:var r=P(e,s[0]);if(Z(s[0])){var a=Number(r).toString(10);e.code.push("Glk.glk_put_jstring("+N(a)+", true);")}else e.code.push("Glk.glk_put_jstring(("+r+").toString(10), true);");break;case 1:I(e),e.code.push("self.stream_num("+e.cp+","+s[0]+", false, 0);"),e.code.push("return;"),e.path_ends=!0;break;case 0:e.code.push("// null streamnum "+s[0])}},114:function(e,s){I(e),e.code.push("if (self.stream_string("+e.cp+","+s[0]+", 0, 0)) return;")},115:function(e,s){switch(e.curiosys){case 2:if(Z(s[0])){var r=Number(s[0]);e.code.push("Glk.glk_put_char_uni("+r+");")}else e.code.push("Glk.glk_put_char_uni("+s[0]+");");break;case 1:I(e),e.code.push("self.tempcallargs[0]=("+s[0]+");"),D(e,"0,0"),e.code.push("self.enter_function(self.iosysrock, 1);"),e.code.push("return;"),e.path_ends=!0;break;case 0:e.code.push("// null streamchar "+s[0])}},320:function(e,s){e.code.push(s[0]+"self.stringtable)")},321:function(e,s){e.code.push("self.set_string_table("+s[0]+");")},328:function(e,s){e.code.push(s[0]+"self.iosysmode)"),e.code.push(s[1]+"self.iosysrock)")},329:function(e,s){if(e.code.push("self.set_iosys("+s[0]+","+s[1]+");"),Z(s[0])){var r=Number(s[0]);e.curiosys=r}else I(e),e.code.push("self.pc = "+e.cp+";"),e.code.push("return;"),e.path_ends=!0},400:function(e,s){var r=P(e,s[0]);if(Z(s[0])){var a=Number(r);e.code.push(s[1]+be(a)+");")}else e.code.push(s[1]+"self.encode_float("+r+"));")},401:function(e,s){e.varsused.valf=!0,e.varsused.res=!0,e.code.push("valf = "+V(e,s[0])+";"),e.code.push("if (!("+s[0]+" & 0x80000000)) {"),e.code.push("  if (isNaN(valf) || !isFinite(valf) || (valf > 0x7fffffff))"),e.code.push("    res = 0x7fffffff;"),e.code.push("  else"),e.code.push("    res = Math.floor(valf);"),e.code.push("} else {"),e.code.push("  if (isNaN(valf) || !isFinite(valf) || (valf < -0x80000000))"),e.code.push("    res = -0x80000000;"),e.code.push("  else"),e.code.push("    res = Math.ceil(valf);"),e.code.push("}"),e.code.push(s[1]+"res>>>0);")},402:function(e,s){e.varsused.valf=!0,e.varsused.res=!0,e.code.push("valf = "+V(e,s[0])+";"),e.code.push("if (!("+s[0]+" & 0x80000000)) {"),e.code.push("  if (isNaN(valf) || !isFinite(valf))"),e.code.push("    res = 0x7fffffff;"),e.code.push("  else"),e.code.push("    res = Math.round(valf);"),e.code.push("  if (res > 0x7fffffff) res = 0x7fffffff;"),e.code.push("} else {"),e.code.push("  if (isNaN(valf) || !isFinite(valf))"),e.code.push("    res = -0x80000000;"),e.code.push("  else"),e.code.push("    res = Math.round(valf);"),e.code.push("  if (res < -0x80000000) res = -0x80000000;"),e.code.push("}"),e.code.push(s[1]+"res>>>0);")},408:function(e,s){var r=V(e,s[0]);e.code.push(s[1]+"self.encode_float(Math.ceil("+r+")));")},409:function(e,s){var r=V(e,s[0]);e.code.push(s[1]+"self.encode_float(Math.floor("+r+")));")},416:function(e,s){var r=V(e,s[0]),a=V(e,s[1]);e.code.push(s[2]+"self.encode_float("+r+" + "+a+"));")},417:function(e,s){var r=V(e,s[0]),a=V(e,s[1]);e.code.push(s[2]+"self.encode_float("+r+" - "+a+"));")},418:function(e,s){var r=V(e,s[0]),a=V(e,s[1]);e.code.push(s[2]+"self.encode_float("+r+" * "+a+"));")},419:function(e,s){var r=V(e,s[0]),a=V(e,s[1]);e.code.push(s[2]+"self.encode_float("+r+" / "+a+"));")},420:function(e,s){var r=V(e,s[0],!0),a=V(e,s[1],!0);e.varsused.modv=!0,e.varsused.quov=!0,e.code.push("modv=("+r+" % "+a+");"),e.code.push("quov=self.encode_float(("+r+" - modv) / "+a+");"),e.code.push("if (quov == 0x0 || quov == 0x80000000) {"),e.code.push("  quov = (("+s[0]+" ^ "+s[1]+") & 0x80000000) >>>0;"),e.code.push("}"),e.code.push(s[2]+"self.encode_float(modv));"),e.code.push(s[3]+"quov);")},424:function(e,s){var r=V(e,s[0]);e.code.push(s[1]+"self.encode_float(Math.sqrt("+r+")));")},425:function(e,s){var r=V(e,s[0]);e.code.push(s[1]+"self.encode_float(Math.exp("+r+")));")},426:function(e,s){var r=V(e,s[0]);e.code.push(s[1]+"self.encode_float(Math.log("+r+")));")},427:function(e,s){e.varsused.valf=!0;var r=V(e,s[0],!0),a=V(e,s[1],!0);e.code.push("if ("+s[0]+" == 0x3f800000) {"),e.code.push("  valf = 0x3f800000;"),e.code.push("} else if ("+s[0]+" == 0xbf800000 && ("+s[1]+" == 0xff800000 || "+s[1]+" == 0x7f800000)) {"),e.code.push("  valf = 0x3f800000;"),e.code.push("} else {"),e.code.push("  valf=self.encode_float(Math.pow("+r+", "+a+"));"),e.code.push("}"),e.code.push(s[2]+"valf);")},432:function(e,s){var r=V(e,s[0]);e.code.push(s[1]+"self.encode_float(Math.sin("+r+")));")},433:function(e,s){var r=V(e,s[0]);e.code.push(s[1]+"self.encode_float(Math.cos("+r+")));")},434:function(e,s){var r=V(e,s[0]);e.code.push(s[1]+"self.encode_float(Math.tan("+r+")));")},435:function(e,s){var r=V(e,s[0]);e.code.push(s[1]+"self.encode_float(Math.asin("+r+")));")},436:function(e,s){var r=V(e,s[0]);e.code.push(s[1]+"self.encode_float(Math.acos("+r+")));")},437:function(e,s){var r=V(e,s[0]);e.code.push(s[1]+"self.encode_float(Math.atan("+r+")));")},438:function(e,s){var r=V(e,s[0]),a=V(e,s[1]);e.code.push(s[2]+"self.encode_float(Math.atan2("+r+", "+a+")));")},448:function(e,s){var r,a,t,o;e.varsused.fequal=!0,e.varsused.fdiff=!0,e.code.push("if (("+s[2]+" & 0x7f800000) == 0x7f800000 && ("+s[2]+" & 0x007fffff) != 0) {"),e.code.push("  fequal = 0;"),e.code.push("} else if (("+s[0]+" == 0xff800000 || "+s[0]+" == 0x7f800000) && ("+s[1]+" == 0xff800000 || "+s[1]+" == 0x7f800000)) {"),e.code.push("  fequal = ("+s[0]+" == "+s[1]+");"),e.code.push("} else {"),Z(s[2])?o=""+_e(2147483647&(r=Number(s[2]))):(r="self.decode_float(("+s[2]+") & 0x7fffffff)",o=O(e),e.code.push(o+"="+r+";")),a=V(e,s[0]),t=V(e,s[1]),e.code.push("  fdiff = "+t+" - "+a+";"),e.code.push("  fequal = (fdiff <= "+o+" && fdiff >= -("+o+"));"),e.code.push("}"),e.code.push("if (fequal) {"),R(e,s[3]),e.code.push("}")},449:function(e,s){var r,a,t,o;e.varsused.fequal=!0,e.varsused.fdiff=!0,e.code.push("if (("+s[2]+" & 0x7f800000) == 0x7f800000 && ("+s[2]+" & 0x007fffff) != 0) {"),e.code.push("  fequal = 0;"),e.code.push("} else if (("+s[0]+" == 0xff800000 || "+s[0]+" == 0x7f800000) && ("+s[1]+" == 0xff800000 || "+s[1]+" == 0x7f800000)) {"),e.code.push("  fequal = ("+s[0]+" == "+s[1]+");"),e.code.push("} else {"),Z(s[2])?o=""+_e(2147483647&(r=Number(s[2]))):(r="self.decode_float(("+s[2]+") & 0x7fffffff)",o=O(e),e.code.push(o+"="+r+";")),a=V(e,s[0]),t=V(e,s[1]),e.code.push("  fdiff = "+t+" - "+a+";"),e.code.push("  fequal = (fdiff <= "+o+" && fdiff >= -("+o+"));"),e.code.push("}"),e.code.push("if (!fequal) {"),R(e,s[3]),e.code.push("}")},450:function(e,s){var r,a;r=V(e,s[0]),a=V(e,s[1]),e.code.push("if ("+r+" < "+a+") {"),R(e,s[2]),e.code.push("}")},451:function(e,s){var r,a;r=V(e,s[0]),a=V(e,s[1]),e.code.push("if ("+r+" <= "+a+") {"),R(e,s[2]),e.code.push("}")},452:function(e,s){var r,a;r=V(e,s[0]),a=V(e,s[1]),e.code.push("if ("+r+" > "+a+") {"),R(e,s[2]),e.code.push("}")},453:function(e,s){var r,a;r=V(e,s[0]),a=V(e,s[1]),e.code.push("if ("+r+" >= "+a+") {"),R(e,s[2]),e.code.push("}")},456:function(e,s){e.code.push("if (("+s[0]+" & 0x7f800000) == 0x7f800000 && ("+s[0]+" & 0x007fffff) != 0) {"),R(e,s[1]),e.code.push("}")},457:function(e,s){e.code.push("if ("+s[0]+" == 0xff800000 || "+s[0]+" == 0x7f800000) {"),R(e,s[1]),e.code.push("}")},304:function(s,r){var a;if((a=!Z(r[0])||Glk.call_may_not_return(Number(r[0])))&&(s.code.push("  self.prevpc = "+s.prevcp+";"),s.code.push("  self.pc = "+s.cp+";")),s.code.push("self.tempglkargs.length = "+r[1]+";"),Z(r[1])){var t,o=Number(r[1]);for(t=0;t<o;t++)if(s.offstack.length){var n=Q(s);s.code.push("self.tempglkargs["+t+"]="+n+";")}else s.code.push("self.tempglkargs["+t+"]=self.frame.valstack.pop();");I(s)}else s.varsused.ix=!0,I(s),s.code.push("for (ix=0; ix<"+r[1]+"; ix++) { self.tempglkargs[ix]=self.frame.valstack.pop(); }");s.varsused.glkret=!0,s.code.push("glkret = GiDispa.get_function("+r[0]+")(self.tempglkargs);"),a&&(s.code.push("if (glkret === Glk.DidNotReturn) {"),s.code.push("  self.resumefuncop = "+function(s){if(0==s.mode)return"null";var r="m"+s.mode;if(null!=s.argsize&&(r=r+"s"+s.argsize),null!=s.addr&&(r=r+"a"+s.addr),e.funcop_cache.key)return"self.funcop_cache."+r;var a={key:r,mode:s.mode,argsize:s.argsize,addr:s.addr};return e.funcop_cache[r]=a,"self.funcop_cache."+r}(r[2])+";"),s.code.push("  self.resumevalue = 0;"),s.code.push("  self.pc = "+s.cp+";"),s.code.push("  self.done_executing = true;"),s.code.push("  return;"),s.code.push("}")),E(s,r[2],"glkret")}};function O(e,s){for(var r,a=0;;){if(r="_hold"+a,!e.holduse[r])return e.holduse[r]=!s||1,r;a++}}function Q(e){var s=e.offstack.pop();if(Z(s))return s;var r=e.holduse[s];return(isNaN(r)||!1===r||!0===r)&&C("Offstack variable not marked as stack.",s),0==--r&&(r=!0),e.holduse[s]=r,s}function B(e,s,r,a){var t=e.offloc[s];if(t&&"_"===t[0]){var o=e.holduse[t];0==--o&&(o=!0),e.holduse[t]=o}if(void 0===r)return e.offloc[s]=void 0,void(e.offlocdirty[s]=!1);if(e.offloc[s]=r,e.offlocdirty[s]=!0,a){var n=r;(o=e.holduse[n])&&!0!==o?o++:o=1,e.holduse[n]=o}}function Z(e){return"0"===e[0]}function J(e,s,r,a){var t,o,n,f,c,d,p;for(a.desttype=0,a.numops=r.numops,t=s,s+=r.numops+1>>1,o=0;o<r.numops;o++){0==(1&o)?f=15&(n=u(t)):(f=n>>4&15,t++);var h=r.formlist[o];if("L"!=h)if("E"!=h)if("S"!=h)if("F"!=h)if("C"!=h)C("Unknown operand type.",h);else{switch(f){case 8:a[o]="3,0";continue;case 0:a[o]="0,0";continue}if(f>=9&&f<=11){9==f?(d=u(s),s++):10==f?(d=l(s),s+=2):11==f&&(d=i(s),s+=4),a[o]="2,"+d;continue}switch(f){case 15:d=i(s)+Ne,s+=4;break;case 14:d=l(s)+Ne,s+=2;break;case 13:d=u(s)+Ne,s++;break;case 7:d=i(s),s+=4;break;case 6:d=l(s),s+=2;break;case 5:d=u(s),s++;break;default:C("Unknown addressing mode in store operand.")}a[o]="1,"+d}else{var m=a.func_store;switch(f){case 8:m.mode=8,m.argsize=r.argsize,a[o]=m;continue;case 0:m.mode=0,m.argsize=r.argsize,a[o]=m;continue}if(f>=9&&f<=11){9==f?(d=u(s),s++):10==f?(d=l(s),s+=2):11==f&&(d=i(s),s+=4),m.mode=11,m.addr=d,m.argsize=r.argsize,a[o]=m;continue}switch(f){case 15:d=i(s)+Ne,s+=4;break;case 14:d=l(s)+Ne,s+=2;break;case 13:d=u(s)+Ne,s++;break;case 7:d=i(s),s+=4;break;case 6:d=l(s),s+=2;break;case 5:d=u(s),s++;break;default:C("Unknown addressing mode in store operand.")}m.mode=15,m.addr=d,m.argsize=r.argsize,a[o]=m}else{switch(f){case 8:p=O(e,!0),e.offstack.push(p),a[o]=p+"=(";continue;case 0:a[o]="(";continue}if(f>=9&&f<=11){9==f?(d=u(s),s++):10==f?(d=l(s),s+=2):11==f&&(d=i(s),s+=4),4==r.argsize?(B(e,d,p=O(e,!0),!1),a[o]=p+"=("):2==r.argsize?(B(e,d,void 0),a[o]="self.frame.locals["+d+"]=(0xffff &"):(B(e,d,void 0),a[o]="self.frame.locals["+d+"]=(0xff &");continue}switch(f){case 15:d=i(s)+Ne,s+=4;break;case 14:d=l(s)+Ne,s+=2;break;case 13:d=u(s)+Ne,s++;break;case 7:d=i(s),s+=4;break;case 6:d=l(s),s+=2;break;case 5:d=u(s),s++;break;default:C("Unknown addressing mode in store operand.")}c=4==r.argsize?"self.MemW4("+d+",":2==r.argsize?"self.MemW2("+d+",":"self.MemW1("+d+",",a[o]=c}else{switch(f){case 8:e.offstack.length?a[o]=Q(e):a[o]="self.frame.valstack.pop()";continue;case 0:a[o]="0";continue;case 1:c=x(s),s++,a[o]=c;continue;case 2:c=y(s),s+=2,a[o]=c;continue;case 3:c=w(s),s+=4,a[o]=c;continue}if(f>=9&&f<=11){if(9==f?(d=u(s),s++):10==f?(d=l(s),s+=2):11==f&&(d=i(s),s+=4),void 0!==e.offloc[d]){a[o]=e.offloc[d];continue}c=4==r.argsize?"self.frame.locals["+d+"]":2==r.argsize?"self.frame.locals["+d+"] & 0xffff":"self.frame.locals["+d+"] & 0xff",p=O(e,!0),e.code.push(p+"=("+c+");"),e.offloc[d]=p,e.offlocdirty[d]=!1,a[o]=p;continue}switch(f){case 15:d=i(s)+Ne,s+=4;break;case 14:d=l(s)+Ne,s+=2;break;case 13:d=u(s)+Ne,s++;break;case 7:d=i(s),s+=4;break;case 6:d=l(s),s+=2;break;case 5:d=u(s),s++;break;default:C("Unknown addressing mode in load operand.")}c=4==r.argsize?"self.Mem4("+d+")":2==r.argsize?"self.Mem2("+d+")":"self.Mem1("+d+")",a[o]=c}else{switch(f){case 8:e.offstack.length?a[o]=Q(e):(p=O(e),e.code.push(p+"=self.frame.valstack.pop();"),a[o]=p);continue;case 0:a[o]="0";continue;case 1:c=x(s),s++,a[o]=c;continue;case 2:c=y(s),s+=2,a[o]=c;continue;case 3:c=w(s),s+=4,a[o]=c;continue}if(f>=9&&f<=11){if(9==f?(d=u(s),s++):10==f?(d=l(s),s+=2):11==f&&(d=i(s),s+=4),void 0!==e.offloc[d]){a[o]=e.offloc[d];continue}c=4==r.argsize?"self.frame.locals["+d+"]":2==r.argsize?"self.frame.locals["+d+"] & 0xffff":"self.frame.locals["+d+"] & 0xff",p=O(e,!0),e.code.push(p+"=("+c+");"),e.offloc[d]=p,e.offlocdirty[d]=!1,a[o]=p;continue}switch(f){case 15:d=i(s)+Ne,s+=4;break;case 14:d=l(s)+Ne,s+=2;break;case 13:d=u(s)+Ne,s++;break;case 7:d=i(s),s+=4;break;case 6:d=l(s),s+=2;break;case 5:d=u(s),s++;break;default:C("Unknown addressing mode in load operand.")}c=4==r.argsize?"self.Mem4("+d+")":2==r.argsize?"self.Mem2("+d+")":"self.Mem1("+d+")",p=O(e),e.code.push(p+"=("+c+");"),a[o]=p}}return s}function K(e,s,r){var a,t,o,n=s,f={vmfunc:e,cp:null,prevcp:null,curiosys:r,code:[],holduse:{},varsused:{},offstack:[],offloc:[],offlocdirty:[],path_ends:!1},c={func_store:{}};for(f.code.push("");!f.path_ends;){f.prevcp=n,t=n,void 0===(a=u(n))&&C("Tried to compile nonexistent address",n),n++,128&a&&(64&a?(a=256*(a=256*(a=256*(a&=63)|u(n))|u(++n))|u(++n),n++):(a=256*(a&=127)|u(n),n++)),f.code.push("// "+t.toString(16)+": opcode "+a.toString(16));var l=W[a];l||C("Encountered unknown opcode.",a),n=J(f,n,l,c),f.cp=n;var i=H[a];for(o in i||C("Encountered unhandled opcode.",a),i(f,c),f.holduse)!0===f.holduse[o]&&(f.holduse[o]=!1);f.offstack.length&&f.code.push("// offstack: "+f.offstack.join(",")),f.offloc.length&&f.code.push("// offloc: "+f.offloc.join(",")+"; dirty: "+f.offlocdirty.join(",")),e.pathaddrs[n]&&!f.path_ends&&(f.code.push("// reached jump-in point"),f.code.push("self.pc="+n+";"),I(f),f.code.push("return;"),f.path_ends=!0)}f.offstack.length&&C("Path compilation ended with nonempty offstack.",f.offstack.length),f.offloc.length&&C("Path compilation ended with nonempty offloc.",f.offloc.length);var d=[];for(o in f.holduse)d.push(o);for(o in f.varsused)d.push(o);return d.length&&(f.code[0]="var "+d.join(",")+";"),L(f.code.join("\n"),"_func_path_"+s)}function X(s,r){var a;Re++;var t=te[s];if(void 0!==t)return He++,void Y(t(r,e.tempcallargs));var o=we[s];void 0===o&&(o=function(e){var s=e,r=u(s);192!=r&&193!=r&&C(r>=192&&r<=223?"Call to unknown type of function.":"Call to non-function.",s);for(var a=[],t=++s;;){var o=u(s),n=u(++s);if(s++,0==o)break;1!=o&&2!=o&&4!=o&&C("Invalid local variable size in function header.",o),a.push({size:o,count:n})}for(var f=xe.slice(t,s);f.length%4;)f.push(0);return new F(e,s,a,f)}(s),s<Ne&&(we[s]=o)),e.pc=o.startpc;var n=new G(o);if(n.depth=ye.length,0==ye.length?n.framestart=0:n.framestart=e.frame.framestart+e.frame.framelen+4*e.frame.valstack.length,ye.push(n),e.frame=n,192==o.functype){for(a=r-1;a>=0;a--)e.frame.valstack.push(e.tempcallargs[a]);e.frame.valstack.push(r)}else for(a=0;a<r;a++){var f=o.localsindex[a];if(void 0===f)break;4==f.size?e.frame.locals[f.pos]=e.tempcallargs[a]:2==f.size?e.frame.locals[f.pos]=65535&e.tempcallargs[a]:1==f.size&&(e.frame.locals[f.pos]=255&e.tempcallargs[a])}}function Y(s){var r,a;isNaN(s)&&C("Function returned undefined value.");var t=e.frame.valstack,o=t.length,n=t[o-1];switch(n!=e.frame.framestart&&(t.length-=1,C("Call stub frameptr ("+n+") does not match frame ("+e.frame.framestart+")")),e.pc=t[o-2],r=t[o-3],a=t[o-4],t.length-=4,a){case 0:return;case 1:return void m(r,s);case 2:return void(e.frame.locals[r]=s);case 3:return void e.frame.valstack.push(s);case 17:return void C("String-terminator call stub at end of function call.");case 16:return void me(0,e.pc,225,r);case 18:return void he(0,e.pc,!0,r);case 19:return void me(0,e.pc,224,r);case 20:return void me(0,e.pc,226,r);default:C("Unrecognized desttype in callstub.",a)}}function $(s){0==s?e.random_func=Math.random:(!function(e){var s,r,a,t,o;void 0===re&&(re=Array(55));for(re[54]=e,ee=0,se=31,a=1,s=0;s<55;s++)re[r=21*s%55]=a,a=e-a>>>0,e=re[r];for(o=0;o<4;o++)for(s=0;s<55;s++)t=re[s]-re[(1+s+30)%55],re[s]=t>>>0}(s),e.random_func=ae)}e.enter_function=X,e.leave_function=function(){var s=e.frame.depth;if(ye.pop(),0==ye.length)return e.frame=null,!0;e.frame=ye[ye.length-1],e.frame.depth!=s-1&&C("Stack inconsistent after function exit.")},e.pop_stack_to=function(s){for(;ye.length&&ye[ye.length-1].framestart>s;)ye.pop();0==ye.length&&C("Stack evaporated during throw."),e.frame=ye[ye.length-1],(s-=e.frame.framestart+e.frame.framelen)<0&&C("Attempted to throw below the frame value stack."),3&s&&C("Attempted to throw to an unaligned address."),(s>>>=2)>e.frame.valstack.length&&C("Attempted to throw beyond the frame value stack."),e.frame.valstack.length=s},e.pop_callstub=Y,e.store_operand=function(s,r,a){switch(s){case 0:return;case 1:return void m(r,a);case 2:return void(e.frame.locals[r]=a);case 3:return void e.frame.valstack.push(a);default:C("Unrecognized desttype in callstub.",s)}},e.set_random=$;var ee,se,re=void 0;function ae(){return se=(se+1)%55,re[ee=(ee+1)%55]=re[ee]-re[se]>>>0,re[ee]/4294967296}var te={},oe={};e.accel_address_map=te,e.accel_funcnum_map=oe;var ne=[0,0,0,0,0,0,0,0,0];e.accel_params=ne;var fe={1:function(s,r){if(s<1)return 0;var a=r[0];if(a<36)return 0;if(a>=e.endmem)return 0;var t=u(a);return t>=224?3:t>=192?2:t>=112&&t<=127&&a>=Ne?1:0},2:function(e,s){var r=e>0?s[0]:0,a=e>1?s[1]:0;if(1!=fe[1](e,s))return Glk.glk_put_jstring('\n[** Programming error: tried to find the "." of (something) **]\n'),0;var t=i(r+16);if(!t)return 0;var o=i(t);return ke(a,2,t+=4,10,o,0,0)},3:function(e,s){var r=le(e>0?s[0]:0,e>1?s[1]:0);return 0==r?0:i(r+4)},4:function(e,s){var r=le(e>0?s[0]:0,e>1?s[1]:0);return 0==r?0:4*l(r+2)},5:function(e,s){var r,a,t,o,n,f=e>0?s[0]:0,c=e>1?s[1]:0;if(3==(r=fe[1](e,s)))return c==ne[5]?1:0;if(2==r)return c==ne[4]?1:0;if(1!=r)return 0;if(c==ne[2])return ue(f)?1:f==ne[2]?1:f==ne[5]?1:f==ne[4]?1:f==ne[3]?1:0;if(c==ne[3])return ue(f)?0:f==ne[2]?0:f==ne[5]?0:f==ne[4]?0:f==ne[3]?0:1;if(c==ne[5]||c==ne[4])return 0;if(!ue(c))return Glk.glk_put_jstring("\n[** Programming error: tried to apply 'ofclass' with non-class **]\n"),0;if(0==(a=le(f,2)))return 0;if(0==(t=i(a+4)))return 0;for(o=l(a+2),n=0;n<o;n++)if(i(t+4*n)==c)return 1;return 0},6:function(e,s){var r,a=e>1?s[1]:0;return 0==(r=fe[3](e,s))?a>0&&a<ne[1]?i(ne[8]+4*a):(Glk.glk_put_jstring("\n[** Programming error: tried to read (something) **]\n"),0):i(r)},7:function(e,s){var r=e>0?s[0]:0,a=e>1?s[1]:0,t=ne[1],o=fe[1](e,s);return 3==o?a==t+6?1:a==t+7?1:0:2==o?a==t+5?1:0:1!=o?0:a>=t&&a<t+8&&ue(r)?1:fe[3](e,s)?1:0},8:function(e,s){var r=e>0?s[0]:0,a=e>1?s[1]:0;if(1!=fe[1](e,s))return Glk.glk_put_jstring('\n[** Programming error: tried to find the "." of (something) **]\n'),0;var t=i(r+4*(3+(ne[7]>>2)));if(!t)return 0;var o=i(t);return ke(a,2,t+=4,10,o,0,0)},9:function(e,s){var r=ie(e>0?s[0]:0,e>1?s[1]:0);return 0==r?0:i(r+4)},10:function(e,s){var r=ie(e>0?s[0]:0,e>1?s[1]:0);return 0==r?0:4*l(r+2)},11:function(e,s){var r,a,t,o,n,f=e>0?s[0]:0,c=e>1?s[1]:0;if(3==(r=fe[1](e,s)))return c==ne[5]?1:0;if(2==r)return c==ne[4]?1:0;if(1!=r)return 0;if(c==ne[2])return ue(f)?1:f==ne[2]?1:f==ne[5]?1:f==ne[4]?1:f==ne[3]?1:0;if(c==ne[3])return ue(f)?0:f==ne[2]?0:f==ne[5]?0:f==ne[4]?0:f==ne[3]?0:1;if(c==ne[5]||c==ne[4])return 0;if(!ue(c))return Glk.glk_put_jstring("\n[** Programming error: tried to apply 'ofclass' with non-class **]\n"),0;if(0==(a=ie(f,2)))return 0;if(0==(t=i(a+4)))return 0;for(o=l(a+2),n=0;n<o;n++)if(i(t+4*n)==c)return 1;return 0},12:function(e,s){var r,a=e>1?s[1]:0;return 0==(r=fe[9](e,s))?a>0&&a<ne[1]?i(ne[8]+4*a):(Glk.glk_put_jstring("\n[** Programming error: tried to read (something) **]\n"),0):i(r)},13:function(e,s){var r=e>0?s[0]:0,a=e>1?s[1]:0,t=ne[1],o=fe[1](e,s);return 3==o?a==t+6?1:a==t+7?1:0:2==o?a==t+5?1:0:1!=o?0:a>=t&&a<t+8&&ue(r)?1:fe[9](e,s)?1:0}};e.accel_func_map=fe;var ce=[0,0];function ue(e){return i(e+13+ne[7])==ne[2]}function le(e,s){var r,a=0;if(4294901760&s){if(a=i(ne[0]+4*(65535&s)),ce[0]=e,ce[1]=a,0==fe[5](2,ce))return 0;s>>=16,e=a}return ce[0]=e,ce[1]=s,0==(r=fe[2](2,ce))?0:ue(e)&&0==a&&(s<ne[1]||s>=ne[1]+8)?0:i(ne[6])!=e&&1&u(r+9)?0:r}function ie(e,s){var r,a=0;if(4294901760&s){if(a=i(ne[0]+4*(65535&s)),ce[0]=e,ce[1]=a,0==fe[11](2,ce))return 0;s>>=16,e=a}return ce[0]=e,ce[1]=s,0==(r=fe[8](2,ce))?0:ue(e)&&0==a&&(s<ne[1]||s>=ne[1]+8)?0:i(ne[6])!=e&&1&u(r+9)?0:r}function de(s){if(e.stringtable!=s&&(ze=void 0,Se=void 0,e.stringtable=s,0!=e.stringtable)){var r=Me[e.stringtable];if(void 0===r){var a=void 0,t=i(e.stringtable),o=i(e.stringtable+8);if(e.stringtable+t<=Ne){var n=Array(1);!function e(s,r,a,t){var o,n,f;var c;n=u(r);if(0==n&&4==a)return(f=Array(16)).type=0,f.depth=4,s[t]=f,void e(f,r,0,0);if(0==n){var l=i(r+1),d=i(r+5);return e(s,l,a+1,t),void e(s,d,a+1,t|1<<a)}r++;f={};f.type=n;f.depth=a;switch(n){case 2:f.value=u(r),f.cchar=M(f.value);break;case 4:f.value=i(r),f.cchar=M(f.value);break;case 3:case 5:f.addr=r;break;case 8:case 9:f.addr=i(r);break;case 10:case 11:f.addr=r;break;case 1:break;default:C("Unknown node type in string table.",n)}c=1<<a;for(o=t;o<16;o+=c)s[o]=f}(n,o,4,0),void 0===(a=n[0])&&C("Failed to create decoding tree.")}r=new A(e.stringtable,a),Me[e.stringtable]=r}ze=r.decoding_tree,Se=r.vmstring_tables[e.iosysmode]}}function pe(s,r){switch(s){case 0:r=0;break;case 1:break;case 2:r=0;break;default:s=0,r=0}e.iosysmode=s,e.iosysrock=r;var a=Me[e.stringtable];Se=void 0===a?void 0:a.vmstring_tables[e.iosysmode]}function he(s,r,a,t){var o=(4294967295&r).toString(10);switch(e.iosysmode){case 2:t&&(o=o.slice(t)),Glk.glk_put_jstring(o,!0);break;case 1:if(a||(e.frame.valstack.push(17,0,s,e.frame.framestart),a=!0),t<o.length){var n=o.charCodeAt(t);return e.frame.valstack.push(18,t+1,r,e.frame.framestart),e.tempcallargs[0]=n,X(e.iosysrock,1),!0}}a&&(e.frame.valstack.pop()!=e.frame.framestart&&C("Call stub frameptr does not match frame."),e.pc=e.frame.valstack.pop(),e.frame.valstack.pop(),17!=e.frame.valstack.pop()&&C("String-on-string call stub while printing number."))}function me(s,r,a,t){for(var o,n,f,c,u,l=0!=a;;){if(n=void 0,o=0==a?r:r+"/"+a+"/"+t,void 0!==Se&&r<Ne?void 0===(n=Se[o])&&(n=ve(e.iosysmode,r,a,t),Se[o]=n,Je++,Ze++):(n=ve(e.iosysmode,r,a,t),Je++),n instanceof Function){if((f=n(e,s,l))instanceof Array){l=!0,r=f[0],a=f[1],t=f[2];continue}if(f)return!0}else if(Glk.glk_put_jstring(n),!l)return!1;if(e.frame.valstack.pop()!=e.frame.framestart&&C("Call stub frameptr does not match frame."),e.pc=e.frame.valstack.pop(),u=e.frame.valstack.pop(),17==(c=e.frame.valstack.pop()))return!0;16==c?(l=!0,t=u,a=225,r=e.pc):C("Function-terminator call stub at end of string.")}}function ve(s,r,a,t){var o,n=r,f=t,c=void 0;n||C("Called compile_string with null address.");var l={startaddr:r,startbitnum:t,buffer:[],code:[]};if(0==a?(226==(o=u(n))?n+=4:n++,f=0):o=a,225==o)if(ze){var d,p,h,m,v,g,k=!1;for(d=u(n),f&&(d>>=f),p=8-f,h=!1,ze instanceof Array||(k=!0),v=ze;!k;){if(p<4)d|=u(n+1)<<p,p+=8,h=!0;if(p-=(g=v[15&d]).depth,d>>=g.depth,(f+=g.depth)>=8)if(n+=1,f-=8,h)h=!1;else d|=u(n)<<p,p+=8;if(g instanceof Array)v=g;else switch(g.type){case 1:k=!0;break;case 2:case 4:switch(s){case 2:l.buffer.push(g.cchar);break;case 1:T(l),U(l),D(l,"0x10,"+f,n),l.code.push("self.tempcallargs[0]="+g.value+";"),l.code.push("self.enter_function(self.iosysrock, 1);"),c=!0,k=!0}v=ze;break;case 3:switch(s){case 2:for(m=g.addr;0!=(z=u(m));)l.buffer.push(M(z)),m++;break;case 1:T(l),U(l),D(l,"0x10,"+f,n),c="["+g.addr+", 0xE0, 0]",k=!0}v=ze;break;case 5:switch(s){case 2:for(m=g.addr;0!=(z=i(m));)l.buffer.push(M(z)),m+=4;break;case 1:T(l),U(l),D(l,"0x10,"+f,n),c="["+g.addr+", 0xE2, 0]",k=!0}v=ze;break;case 8:case 9:case 10:case 11:T(l),U(l),l.code.push("var otype, retval;"),l.code.push("var oaddr = "+g.addr+";"),g.type>=9&&l.code.push("oaddr = self.Mem4(oaddr);"),11==g.type&&l.code.push("oaddr = self.Mem4(oaddr);"),l.code.push("otype = self.Mem1(oaddr);"),c="retval",k=!0,D(l,"0x10,"+f,n),l.code.push("if (otype >= 0xE0 && otype <= 0xFF) {"),l.code.push("retval = [oaddr, 0, 0];"),l.code.push("}"),l.code.push("else if (otype >= 0xC0 && otype <= 0xDF) {");var _=0;if(10==g.type||11==g.type){_=i(g.addr+4);for(var b=0;b<_;b++)l.code.push("self.tempcallargs["+b+"]="+i(g.addr+8+4*b)+";")}l.code.push("self.enter_function(oaddr, "+_+");"),l.code.push("retval = true;"),l.code.push("}"),l.code.push("else {"),l.code.push("self.fatal_error('Unknown object while decoding string indirect reference.', otype);"),l.code.push("}");break;default:C("Unknown entity in string decoding (cached).")}}}else{var x,y,w;k=!1;for(e.stringtable||C("Attempted to print a compressed string with no table set."),y=u(n),f&&(y>>=f),x=i(e.stringtable+8);!k;)switch(w=u(x),x++,w){case 0:x=i(1&y?x+4:x+0),7==f?(f=0,y=u(++n)):(f++,y>>=1);break;case 1:c=!1,k=!0;break;case 2:switch(z=u(x),s){case 2:l.buffer.push(M(z));break;case 1:T(l),U(l),D(l,"0x10,"+f,n),l.code.push("self.tempcallargs[0]="+z+";"),l.code.push("self.enter_function(self.iosysrock, 1);"),c=!0,k=!0}x=i(e.stringtable+8);break;case 4:switch(z=i(x),s){case 2:l.buffer.push(M(z));break;case 1:T(l),U(l),D(l,"0x10,"+f,n),l.code.push("self.tempcallargs[0]="+z+";"),l.code.push("self.enter_function(self.iosysrock, 1);"),c=!0,k=!0}x=i(e.stringtable+8);break;case 3:switch(s){case 2:for(;0!=(z=u(x));)l.buffer.push(M(z)),x++;break;case 1:T(l),U(l),D(l,"0x10,"+f,n),c="["+x+", 0xE0, 0]",k=!0}x=i(e.stringtable+8);break;case 5:switch(s){case 2:for(;0!=(z=i(x));)l.buffer.push(M(z)),x+=4;break;case 1:T(l),U(l),D(l,"0x10,"+f,n),c="["+x+", 0xE2, 0]",k=!0}x=i(e.stringtable+8);break;case 8:case 9:case 10:case 11:T(l),U(l),l.code.push("var otype, retval;"),l.code.push("var oaddr = "+i(x)+";"),9!=w&&11!=w||l.code.push("oaddr = self.Mem4(oaddr);"),l.code.push("otype = self.Mem1(oaddr);"),c="retval",k=!0,D(l,"0x10,"+f,n),l.code.push("if (otype >= 0xE0 && otype <= 0xFF) {"),l.code.push("retval = [oaddr, 0, 0];"),l.code.push("}"),l.code.push("else if (otype >= 0xC0 && otype <= 0xDF) {");_=0;if(10==w||11==w){_=i(x+4);for(b=0;b<_;b++)l.code.push("self.tempcallargs["+b+"]="+i(x+8+4*b)+";")}l.code.push("self.enter_function(oaddr, "+_+");"),l.code.push("retval = true;"),l.code.push("}"),l.code.push("else {"),l.code.push("self.fatal_error('Unknown object while decoding string indirect reference.', otype);"),l.code.push("}");break;default:C("Unknown entity in string decoding.",w)}}else if(224==o){switch(s){case 2:for(;z=u(n),n++,0!=z;)l.buffer.push(M(z));break;case 1:T(l),U(l),z=u(n),n++,0!=z?(D(l,"0x13,0",n),l.code.push("self.tempcallargs[0]="+z+";"),l.code.push("self.enter_function(self.iosysrock, 1);"),c=!0):c="false"}}else if(226==o){var z;switch(s){case 2:for(;z=i(n),n+=4,0!=z;)l.buffer.push(M(z));break;case 1:T(l),U(l),z=i(n),n+=4,0!=z?(D(l,"0x14,0",n),l.code.push("self.tempcallargs[0]="+z+";"),l.code.push("self.enter_function(self.iosysrock, 1);"),c=!0):c="false"}}else C(o>=224&&o<=255?"Attempt to print unknown type of string.":"Attempt to print non-string.");return c?(T(l),l.code.push("return "+c+";"),L(l.code.join("\n"),"_func_str_"+r,"nextcp","substring")):(l.code.length>1&&C("Simple-case string generated code."),l.buffer.join(""))}function ge(e,s,r){if(1&r)return d(e,s);switch(s){case 4:return[e>>24&255,e>>16&255,e>>8&255,255&e];case 2:return[e>>8&255,255&e];case 1:return[255&e];default:C("Direct search key must hold one, two, or four bytes.")}}function ke(e,s,r,a,t,o,n){var f,c,l,i,d,p,h,m,v=0!=(4&n),g=ge(e,s,n);for(c=0,f=t;c<f;){for(d=0,l=r+(i=f+c>>1)*a,p=0;!d&&p<s;p++)(h=u(l+o+p))<(m=g[p])?d=-1:h>m&&(d=1);if(!d)return v?i:l;d<0?c=i+1:f=i}return v?4294967295:0}function _e(e){var s,r,a;return 2147483648&e?(s=!0,e&=2147483647):s=!1,0==e?s?-0:0:2139095040==(2139095040&e)?0==(8388607&e)?s?-1/0:1/0:NaN:(r=(a=e>>23&255)?(8388607&e|8388608)/8388608*Math.pow(2,a-127):(8388607&e)/8388608*Math.pow(2,-126),s?-r:r)}function be(e){var s,r,a,t,o;return isNaN(e)?2139095041:isFinite(e)?0==e?1/e<0?2147483648:0:(e<0?(o=!0,s=-e):(o=!1,s=e),t=Math.floor(Math.log(s)/Math.log(2)),a=s/Math.pow(2,t),t>=128?o?4286578688:2139095040:(t<-126?(a*=Math.pow(2,126+t),t=0):0==t&&0==a||(t+=127,a-=1),(r=(a*=8388608)+.4999999999999999<<0)>=8388608&&(r=0,++t>=255)?o?4286578688:2139095040:o?(2147483648|t<<23|r)>>>0:t<<23|r)):e<0?4286578688:2139095040}e.set_string_table=de,e.set_iosys=pe,e.stream_num=he,e.stream_string=me,e.do_gestalt=function(e,s){switch(e){case 0:return 196866;case 1:return 131334;case 2:case 3:return 1;case 4:switch(s){case 0:case 1:case 2:return 1;default:return 0}break;case 5:case 6:case 7:return 1;case 8:return qe;case 9:return 1;case 10:return fe[s]?1:0;case 11:return 1;default:return 0}},e.linear_search=function(e,s,r,a,t,o,n){var f,c,u,l,i=0!=(4&n),p=0!=(2&n),h=ge(e,s,n);for(c=0;c<t;c++,r+=a){for(u=!0,l=d(r+o,s),f=0;u&&f<s;f++)l[f]!=h[f]&&(u=!1);if(u)return i?c:r;if(p){for(u=!0,l=d(r+o,s),f=0;u&&f<s;f++)0!=l[f]&&(u=!1);if(u)break}}return i?4294967295:0},e.binary_search=ke,e.linked_search=function(e,s,r,a,t,o){for(var n,f,c=0!=(2&o),l=ge(e,s,o);0!=r;){for(f=!0,n=0;f&&n<s;n++)u(r+a+n)!=l[n]&&(f=!1);if(f)return r;if(c){for(f=!0,n=0;f&&n<s;n++)0!=u(r+a+n)&&(f=!1);if(f)break}r=i(r+t)}return 0},e.decode_float=_e,e.encode_float=be;var xe,ye,we,Me,ze,Se,Ne,Ce,Le,Fe,Ge,je,qe,Ae,We,Ee=null,De=null,Ue=null,Ie=null,Te=null,Pe=null;e.frame=null,e.vm_started=!1,e.vm_stopped=!1,e.tempcallargs=null,e.tempglkargs=null,e.done_executing=null,e.random_func=null,e.pc=null,e.stringtable=null,e.endmem=null,e.protectstart=null,e.protectend=null,e.iosysmode=null,e.iosysrock=null,e.prevpc=null,e.resumefuncop=null,e.resumevalue=null;var Ve=0,Re=0,He=0,Oe=0,Qe=0,Be=0,Ze=0,Je=0;function Ke(){rs();var s=es();xe=null,xe=Ee.slice(0,Ce),e.endmem=xe.length,$e(Le,!1),ss(s),ye=[],e.frame=null,e.pc=0,e.prevpc=0,e.iosysmode=0,e.iosysrock=0,de(Ge),X(Fe,0)}function Xe(e){for(var s=[],r=0;r<e.length;r++){var a=e[r].key,t=e[r].chunk;4!=a.length&&C("Bad chunk ID (must be exactly 4 chars): "+a),null==t&&C("Missing chunk data: "+a),v(s,a),g(s,t.length),1&(s=s.concat(t)).length&&s.push(0)}return s}function Ye(e){for(var s={},a=0;a<e.length;){if(a+8>e.length)return void r("IFF chunk header is truncated");var t=b(e,a,4),o=n(e,a+4);if((a+=8)+o>e.length)return void r(t+" chunk is truncated ("+o+" bytes needed, "+(e.length-a)+" available");s[t]=e.slice(a,a+o),1&(a+=o)&&(a+=1)}return s}function $e(s,r){var a;if(s!=e.endmem){if(!r&&as()&&C("Cannot resize Glulx memory space while heap is active."),s<Le&&C("Cannot resize Glulx memory space smaller than it started."),255&s&&C("Can only resize Glulx memory space to a 256-byte boundary."),xe.length=s,s>e.endmem)for(a=e.endmem;a<s;a++)xe[a]=0;e.endmem=s}}function es(){if(e.protectstart>=e.protectend)return null;for(var s=e.protectend-e.protectstart,r={start:e.protectstart,end:e.protectend,len:s},a=xe.slice(e.protectstart,e.protectend);a.length<s;)a.push(0);return r.mem=a,r}function ss(s){if(s){var r,a,t=s.mem,o=s.start,n=s.end;for(n>e.endmem&&(n=e.endmem),r=0,a=o;a<n;r++,a++)xe[a]=t[r]}}function rs(){qe=0,Ae=[],We=[]}function as(){return Ae.length>0}function ts(e,s){this.addr=e,this.size=s,this.end=e+s}function os(e,s){for(var r=0,a=e.length;r<a;){var t=r+a>>1;e[t].addr<s?r=t+1:a=t}return r}function ns(){if(!as())return 0!=qe&&C("Heap inconsistency: heapstart nonzero"),Ae.length>0&&C("Heap inconsistency: usedlist nonempty"),void(We.length>0&&C("Heap inconsistency: usedlist nonempty"));0==qe&&C("Heap inconsistency: heapstart is zero");for(var s=qe,r=0,a=0;r<Ae.length||a<We.length;){var t=Ae[r],o=We[a];t&&t.addr==s?(s+=t.size,r++):o&&o.addr==s?(s+=o.size,a++):C("Heap inconsistency: no block at address "+s)}s!=e.endmem&&C("Heap inconsistency: overrun at end of heap")}e.vm_restart=Ke,e.vm_save=function(s){xe.length!=e.endmem&&C("Memory length was incorrect before save."),2!=e.iosysmode&&C("Streams are only available in Glk I/O system.");var r=GiDispa.class_obj_from_id("stream",s);if(!r)return!1;var a=[];a.push({key:"IFhd",chunk:Ee.slice(0,128)});for(var t,o,n,f=xe.slice(Ne),c=Ne;c<Ee.length;c++)f[c-Ne]^=Ee[c];(f=function(e){for(var s=[],r=0;r<e.length;){for(var a=0;r<e.length&&0==e[r]&&a<=255;)a++,r++;for(a>0&&(s.push(0),s.push(a-1));r<e.length&&0!=e[r];)s.push(e[r]),r++}return s}(f)).splice(0,0,0,0,0,0),t=f,o=0,n=e.endmem,t[o]=n>>24&255,t[o+1]=n>>16&255,t[o+2]=n>>8&255,t[o+3]=255&n,a.push({key:"CMem",chunk:f});var u=[];for(a.push({key:"Stks",chunk:u}),c=0;c<ye.length;c++)j(ye[c],u);if(as()){var l=[];a.push({key:"MAll",chunk:l}),g(l,qe),g(l,Ae.length);for(c=0;c<Ae.length;c++)g(l,Ae[c].addr),g(l,Ae[c].size)}var i=[];v(i,"IFZS"),i=i.concat(Xe(a));var d=Xe([{key:"FORM",chunk:i}]);return Glk.glk_put_buffer_stream(r,d),!0},e.vm_restore=function(s){2!=e.iosysmode&&C("Streams are only available in Glk I/O system.");var a=GiDispa.class_obj_from_id("stream",s);if(!a)return!1;for(var t=new Array(0),o=new Array(1024),f=1;f>0;)f=Glk.glk_get_buffer_stream(a,o),t=t.concat(o.slice(0,f));if(!(t=Ye(t)))return r("vm_restore failed: file is not Quetzal"),!1;if(!(t=t.FORM)||"IFZS"!=b(t,0,4))return r("vm_restore failed: file doesn't start with FORM/IFZS header"),!1;var c=Ye(t.slice(4));if(!c.IFhd)return r("vm_restore failed: missing required IFhd chunk"),!1;for(var u=0;u<128;u++)if(c.IFhd[u]!=Ee[u])return r("vm_restore failed: this save image is for a different game"),!1;if(!c.CMem)return r("vm_restore failed: missing required CMem chunk"),!1;if(!c.Stks)return r("vm_restore failed: missing required Stks chunk"),!1;var l=es();rs();var i=n(c.CMem,0),d=c.CMem.slice(4);for(d=function(e){for(var s=[],r=0;r<e.length;){var a=e[r++];if(0==a)for(var t=e[r++]+1,o=0;o<t;o++)s.push(0);else s.push(a)}return s}(d);d.length<i-Ne;)d.push(0);for($e(i,!1),xe=Ee.slice(0,Ne).concat(d),u=Ne;u<Ee.length;u++)xe[u]^=Ee[u];xe.length!=e.endmem&&C("Memory length was incorrect after restore.");var p=c.Stks;for(ye=[];p.length;)e.frame=q(p),e.frame||C("vm_restore failed: bad stack frame"),ye.unshift(e.frame);for(u=0;u<ye.length;u++)ye[u].depth=u;e.frame=ye[ye.length-1];var h=c.MAll;if(h&&h.length>=8){qe=n(h,0);var m=n(h,4);for(u=0;u<m;u++){var v=n(h,8+8*u),g=n(h,12+8*u);Ae.push(new ts(v,g))}Ae.sort(function(e,s){return e.addr-s.addr});var k=qe;for(u=0;u<Ae.length;u++){v=Ae[u].addr,g=Ae[u].size;(v<k||v+g>e.endmem)&&C("vm_restore failed: corrupt dynamic heap"),v>k&&We.push(new ts(k,v-k)),k=v+g}k<e.endmem&&We.push(new ts(k,e.endmem-k))}return ns(),ss(l),!0},e.vm_saveundo=function(){xe.length!=e.endmem&&C("Memory length was incorrect before saveundo.");var s,r,a={};a.ram=xe.slice(Ne),a.endmem=e.endmem,a.pc=e.pc,a.stack=[];for(var t=0;t<ye.length;t++)a.stack[t]=(s=ye[t],r=void 0,(r=new G(s.vmfunc)).depth=s.depth,r.framestart=s.framestart,r.framelen=s.framelen,r.valstack=s.valstack.slice(0),r.localspos=s.localspos,r.locals=s.locals.slice(0),r.framelen=s.framelen,r);a.heapstart=qe,a.usedlist=Ae.slice(0),a.freelist=We.slice(0),je.push(a),je.length>10&&je.shift()},e.vm_restoreundo=function(){if(0==je.length)return!1;var s=je.pop(),r=es();return xe=xe.slice(0,Ne).concat(s.ram),e.endmem=s.endmem,ye=s.stack,e.frame=ye[ye.length-1],e.pc=s.pc,qe=s.heapstart,Ae=s.usedlist,We=s.freelist,ss(r),xe.length!=e.endmem&&C("Memory length was incorrect after undo."),ns(),!0},e.change_memsize=$e,e.perform_verify=function(){var e,s,r,a=Ee.length;if(a<256||0!=(255&a))return 1;if(a!=n(Ee,12))return 1;for(s=-(r=n(Ee,32))>>>0,e=0;e<a;e+=4)s=s+n(Ee,e)>>>0;return s!=r?1:0},e.heap_malloc=function(s){as()||(qe=e.endmem);for(var r=0,a=We.length;r<a;r++){var t=We[r];if(t.size>=s){t.size>s?We[r]=new ts(t.addr+s,t.size-s):We.splice(r,1);var o=os(Ae,t.addr);return Ae.splice(o,0,new ts(t.addr,s)),t.addr}}var n=e.endmem,f=s+255&4294967040;return $e(e.endmem+f,!0),f>s&&We.push(new ts(n+s,f-s)),Ae.push(new ts(n,s)),n},e.heap_free=function(e){var s=os(Ae,e),r=Ae[s];if(r&&r.addr==e||C("Tried to free non-existent block"),Ae.splice(s,1),0==Ae.length)return $e(qe,!0),void rs();s=os(We,e);var a=We[s];a&&a.addr==r.end&&(r=new ts(e,r.size+a.size),We.splice(s,1));var t=We[s-1];t&&t.end==r.addr&&(r=new ts(t.addr,t.size+r.size),We.splice(s-1,1),s-=1),We.splice(s,0,r)},e.assert_heap_valid=ns;var fs={map:{},functions:[],functionmap:{}};function cs(){var s,a,t,o,n;for(e.resumefuncop&&(!function(s,r){if(s)switch(s.mode){case 8:return void e.frame.valstack.push(r);case 0:return;case 11:return void(4==s.argsize?e.frame.locals[s.addr]=r:2==s.argsize?e.frame.locals[s.addr]=65535&r:e.frame.locals[s.addr]=255&r);case 15:return void(4==s.argsize?m(s.addr,r):2==s.argsize?h(s.addr,r):p(s.addr,r));default:C("Unknown addressing mode in store func by operand.")}}(e.resumefuncop,e.resumevalue),e.resumefuncop=null,e.resumevalue=0),o=(new Date).getTime();!e.done_executing;){void 0===(t=(a=(s=e.frame.vmfunc)[e.iosysmode])[e.pc])&&(s.pathaddrs[e.pc]=!0,t=K(s,e.pc,e.iosysmode),Be++,e.pc<Ne&&(a[e.pc]=t,Qe++)),Oe++,t(e)===e.VMStopped&&(e.done_executing=!0,e.vm_stopped=!0)}n=(new Date).getTime(),Ve+=(n-o)/1e3,e.vm_stopped&&Glk.glk_exit(),Glk.update(),Ue&&r("event executed in "+(n-o)+" ms")}return e.VMStopped={dummy:"The top-level function has returned."},{version:"2.1.6",prepare:function(e,s){var a,t,o=(Ee=e).slice(0,64);for(a=0;a<o.length;a++)(t=o[a].toString(16)).length<2&&(t="0"+t),o[a]=t;De=o.join(""),s&&(Ue=s.log_execution_time,Ie=s.rethrow_exceptions,Te=s.do_vm_autosave,Pe=s.clear_vm_autosave),s&&s.debug_info_chunk&&function(){var e,s,a,t=GiLoad.get_debug_info();if(!t)return;if(222!=t[0]||191!=t[1]||0!=t[2]||0!=t[3])return void r("Dbug chunk did not contain an (old-style) Inform gameinfo.dbg file");t[4],t[5];s=6,e=!1;for(;!e;){var o=t[s++];switch(o){case 0:case void 0:e=!0;break;case 1:t[s++];for(a=s;t[s];)s++;String.fromCharCode.apply(this,t.slice(a,s));for(a=++s;t[s];)s++;String.fromCharCode.apply(this,t.slice(a,s));s++;break;case 2:for(a=s;t[s];)s++;String.fromCharCode.apply(this,t.slice(a,s));s++;t.slice(s,s+4);s+=4;t.slice(s,s+4);s+=4;break;case 3:t[s++],t[s++];for(a=s;t[s];)s++;String.fromCharCode.apply(this,t.slice(a,s));s++;t.slice(s,s+4);s+=4;t.slice(s,s+4);s+=4;break;case 4:t[s++];for(a=s;t[s];)s++;var n=String.fromCharCode.apply(this,t.slice(a,s));s++;break;case 5:case 6:case 7:case 8:t[s++],t[s++];for(a=s;t[s];)s++;n=String.fromCharCode.apply(this,t.slice(a,s));s++;break;case 9:s+=64;break;case 10:var f=t[s++]<<8|t[s++],c=t[s++]<<8|t[s++];s+=6*c;break;case 11:f=t[s++]<<8|t[s++],t.slice(s,s+4);s+=4;var u=t[s++]<<16|t[s++]<<8|t[s++];for(a=s;t[s];)s++;var l=String.fromCharCode.apply(this,t.slice(a,s));s++;for(var i=[];t[s];){for(a=s;t[s];)s++;var d=String.fromCharCode.apply(this,t.slice(a,s));s++,i.push(d)}s++,fs.functions.push({num:f,name:l,addr:u,locals:i});break;case 12:t[s++],t[s++];for(a=s;t[s];)s++;n=String.fromCharCode.apply(this,t.slice(a,s));s++;break;case 13:for(;t[s];){for(a=s;t[s];)s++;n=String.fromCharCode.apply(this,t.slice(a,s));s++;var p=t[s++]<<16|t[s++]<<8|t[s++];fs.map[n]=p}s++;break;case 14:f=t[s++]<<8|t[s++],t.slice(s,s+4);s+=4;t[s++],t[s++],t[s++];break;default:r("Unknown record type in debug data: "+o),e=!0}}var h,m=fs.map["code area"];if(m)for(h=0;h<fs.functions.length;h++){var v=fs.functions[h];fs.functionmap[m+v.addr]=v}}()},init:function(){if(e.vm_started)Glk.fatal_error("Quixe was inited twice!");else try{!function(){var e,s;for(e=0;e<256;e++)s=e.toString(16),e<16&&(s="0"+s),t[e]=s;for(e=0;e<256;e++)s=e>=32&&e<127?34==e||39==e||92==e?"\\"+String.fromCharCode(e):String.fromCharCode(e):10==e?"\\n":"\\x"+t[e],o[e]=s}(),function(){function e(e,s){this.argsize=s||4,this.numops=e.length;for(var r=[],a=0;a<e.length;a++)r.push(e.charAt(a));this.formlist=r}var s=new e(""),r=new e("L"),a=new e("LL"),t=new e("LLL"),o=new e("LLLL"),n=new e("LS"),f=new e("LLS"),c=new e("LLLLLLS"),u=new e("LLLLLLLS"),l=new e("LLSS"),i=new e("LC"),d=new e("LLC"),p=new e("LLLC"),h=new e("LLLLC"),m=new e("ES"),v=new e("LES"),g=new e("EES"),k=new e("F"),_=new e("LF"),b=new e("LLF"),x=new e("EF"),y=new e("EF",1),w=new e("EF",2),M=new e("S"),z=new e("SS"),S=new e("CL"),N=new e("C");W={0:s,16:g,17:v,18:f,19:f,20:f,21:m,24:g,25:g,26:g,27:m,28:f,29:f,30:f,32:r,34:a,35:a,36:t,37:t,38:t,39:t,40:t,41:t,42:t,43:t,44:t,45:t,48:d,49:r,50:S,51:a,52:a,64:x,65:w,66:y,68:n,69:n,72:f,73:f,74:f,75:f,76:t,77:t,78:t,79:t,80:k,81:_,82:s,83:a,84:r,112:r,113:r,114:r,115:r,256:f,257:r,258:M,259:n,260:r,272:n,273:r,288:s,289:M,290:s,291:i,292:_,293:N,294:k,295:a,304:b,320:M,321:r,328:z,329:a,336:u,337:u,338:c,352:i,353:d,354:p,355:h,368:a,369:t,376:n,377:r,384:a,385:a,400:n,401:n,402:n,408:n,409:n,416:f,417:f,418:f,419:f,420:l,424:n,425:n,426:n,427:f,432:n,433:n,434:n,435:n,436:n,437:n,438:f,448:o,449:o,450:t,451:t,452:t,453:t,456:a,457:a}}(),function(){var a;Ee||C("There is no Glulx game file loaded.");e.vm_started=!0,e.resumefuncop=null,e.resumevalue=0,xe=null,ye=[],e.frame=null,e.pc=0,e.prevpc=0,Ee.length<36&&C("This is too short to be a valid Glulx file.");1198290284!=n(Ee,0)&&C("This is not a valid Glulx file.");(a=n(Ee,4))<131072&&C("This Glulx file is too old a version to execute.");a>=197120&&C("This Glulx file is too new a version to execute.");Ne=n(Ee,8),Ce=n(Ee,12),Le=n(Ee,16),n(Ee,20),Fe=n(Ee,24),Ge=n(Ee,28),n(Ee,32),e.protectstart=0,e.protectend=0,(Ne<256||Ce<Ne||Le<Ce)&&C("The segment boundaries in the header are in an impossible order.");Ce!=Ee.length&&C("The game file length does not agree with the header.");e.done_executing=!1,we={},Me={},ze=void 0,Se=void 0,e.tempcallargs=Array(8),e.tempglkargs=Array(8),$(0),e.endmem=Le,e.stringtable=0,je=[],qe=0,Ae=[],We=[],Pe&&Dialog.autosave_write(De,null);if(Te&&!Pe)try{var t=Dialog.autosave_read(De);if(t)return r("Found autosave..."),void function(s){xe=(xe=Ee.slice(0,Ce)).slice(0,Ne).concat(s.ram),e.endmem=s.endmem,e.pc=s.pc,ye=[];var r=s.stack.slice(0);for(;r.length;){var a=q(r);a||C("vm_autorestore failed: bad stack frame"),ye.unshift(a)}for(var t=0;t<ye.length;t++)ye[t].depth=t;if(e.frame=ye[ye.length-1],void 0===s.heapstart)qe=0,Ae=[],We=[];else{qe=s.heapstart,Ae=[];for(var o=0;o<s.usedlist.length;o+=2){var n=s.usedlist[o],f=s.usedlist[o+1];Ae.push(new ts(n,f))}Ae.sort(function(e,s){return e.addr-s.addr}),We=[];var c=qe;for(t=0;t<Ae.length;t++){n=Ae[t].addr,f=Ae[t].size;(n<c||n+f>e.endmem)&&C("vm_autorestore failed: corrupt dynamic heap"),n>c&&We.push(new ts(c,n-c)),c=n+f}c<e.endmem&&We.push(new ts(c,e.endmem-c))}ns(),de(s.stringtable),pe(s.iosysmode,s.iosysrock),e.protectstart=s.protectstart,e.protectend=s.protectend,void 0===s.srand_table?$(0):($(1),re=s.srand_table.slice(0),ee=s.srand_index1,se=s.srand_index2);for(var o in ne=s.accel_params.slice(0),s.accel_funcnum_map)oe[o]=s.accel_funcnum_map[o],te[o]=e.accel_func_map[oe[o]];Glk.restore_allstate(s.glk),Y(0)}(t)}catch(e){r("Autorestore failed, deleting it: "+s(e)),e.stack&&r("JS stack dump:\n"+e.stack),Dialog.autosave_write(De,null)}Ke()}(),cs()}catch(e){if(e.stack&&r("JS stack dump:\n"+e.stack),a(),Glk.fatal_error("Quixe init: "+s(e)),Ie)throw e}},resume:function(t){try{e.done_executing=e.vm_stopped,cs()}catch(e){if(e.stack&&r("JS stack dump:\n"+e.stack),a(),Glk.fatal_error("Quixe run: "+s(e)),Ie)throw e}},get_signature:function(){return De},get_vm_internals:function(){return e},get_statistics:function(){return{game_image_length:Ee.length,total_execution_time:Ve,total_function_calls:Re,accel_function_calls:He,total_path_calls:Oe,paths_cached:Qe,paths_compiled:Be,strings_cached:Ze,strings_compiled:Je}},get_debuginfo:function(){return fs},ReadByte:function(s){return 4294967295==s?255&e.frame.valstack.pop():u(s)},WriteByte:function(s,r){4294967295==s?e.frame.valstack.push(255&r):p(s,r)},ReadWord:function(s){return 4294967295==s?e.frame.valstack.pop():i(s)},WriteWord:function(s,r){4294967295==s?e.frame.valstack.push(r):m(s,r)},ReadStructField:function(s,r){return 4294967295==s?e.frame.valstack.pop():i(s+4*r)},WriteStructField:function(s,r,a){4294967295==s?e.frame.valstack.push(a):m(s+4*r,a)},SetResumeStore:function(s){e.resumevalue=s},do_autosave:function(s){if(s<0)Dialog.autosave_write(De,null);else{var a,t,o=(a=e.prevpc,t=u(a),a++,128&t&&(64&t?(t=(t=(t=(t&=63)<<8|u(a))<<8|u(++a))<<8|u(++a),a++):(t=(t&=127)<<8|u(a),a++)),304!=t?(r("parse_partial_operand: parsed wrong opcode: "+t),null):{selop:15&u(a),argsop:u(a)>>4&15,resop:15&u(a+1)});if(o){var n={},f=e.frame.valstack,c=f.length;f.push(s),8==o.argsop&&f.push(1),8==o.selop&&f.push(192),f.push(0,0,e.prevpc,e.frame.framestart),n.ram=xe.slice(Ne),n.endmem=e.endmem,n.pc=e.pc,n.stack=[];for(var l=0;l<ye.length;l++)j(ye[l],n.stack);if(as()){n.heapstart=qe,n.usedlist=[];for(l=0;l<Ae.length;l++)n.usedlist.push(Ae[l].addr),n.usedlist.push(Ae[l].size)}for(var i in f.length=c,n.stringtable=e.stringtable,n.iosysmode=e.iosysmode,n.iosysrock=e.iosysrock,n.protectstart=e.protectstart,n.protectend=e.protectend,e.random_func==ae&&re&&(n.srand_table=re.slice(0),n.srand_index1=ee,n.srand_index2=se),n.accel_params=ne.slice(0),n.accel_funcnum_map={},oe)n.accel_funcnum_map[i]=oe[i];n.glk=Glk.save_allstate(),Dialog.autosave_write(De,n)}}}}}();

var GiDispa=function(){var e={};e.VM=null;var n={0:"window",1:"stream",2:"fileref",3:"schannel"};function r(e,n,r){this.id=e,this.name=n,this.proto=r}function t(e,n){this.args=e,this.retarg=n}function w(){this.macro="Byte",this.refsize=1,this.serialize=function(){return{type:"ArgString"}}}function l(){this.macro="Word",this.refsize=4,this.serialize=function(){return{type:"ArgUnicode"}}}function s(e){this.signed=e,this.macro="Byte",this.refsize=1,this.literal=e?"arg_char_signed":"arg_char_unsigned",this.serialize=function(){return{type:"ArgChar",signed:e}}}function i(e){this.signed=e,this.macro="Word",this.refsize=4,this.literal=e?"arg_int_signed":"arg_int_unsigned",this.serialize=function(){return{type:"ArgInt",signed:e}}}function a(e){this.name=e,this.macro="Word",this.refsize=4}function u(e){this.form=e}function _(e,n,r,t){this.arg=e,this.passin=n,this.passout=r,this.nonnull=t}function o(e,n,r,t,w){this.arg=e,this.retained=n,this.passin=r,this.passout=t,this.nonnull=w}function c(e){switch(e.type){case"ArgString":return new w;case"ArgUnicode":return new l;case"ArgInt":return e.signed?g:f;case"ArgChar":return null===e.signed?d:e.signed?p:h}throw new Error("arg_deserialize: unknown type: "+e.type)}var f=new i(!1),g=new i(!0),h=new s(!1),d=new s(null),p=new s(!0),m=new a("window"),y=new a("stream"),k=new a("fileref"),v=new a("schannel"),b={1:new r(1,"exit",new t([],null)),3:new r(3,"tick",new t([],null)),4:new r(4,"gestalt",new t([f,f],new _(f,!1,!0,!0))),5:new r(5,"gestalt_ext",new t([f,f,new o(f,!1,!0,!0,!1)],new _(f,!1,!0,!0))),32:new r(32,"window_iterate",new t([m,new _(f,!1,!0,!1)],new _(m,!1,!0,!0))),33:new r(33,"window_get_rock",new t([m],new _(f,!1,!0,!0))),34:new r(34,"window_get_root",new t([],new _(m,!1,!0,!0))),35:new r(35,"window_open",new t([m,f,f,f,f],new _(m,!1,!0,!0))),36:new r(36,"window_close",new t([m,new _(new u(new t([f,f],null)),!1,!0,!1)],null)),37:new r(37,"window_get_size",new t([m,new _(f,!1,!0,!1),new _(f,!1,!0,!1)],null)),38:new r(38,"window_set_arrangement",new t([m,f,f,m],null)),39:new r(39,"window_get_arrangement",new t([m,new _(f,!1,!0,!1),new _(f,!1,!0,!1),new _(m,!1,!0,!1)],null)),40:new r(40,"window_get_type",new t([m],new _(f,!1,!0,!0))),41:new r(41,"window_get_parent",new t([m],new _(m,!1,!0,!0))),42:new r(42,"window_clear",new t([m],null)),43:new r(43,"window_move_cursor",new t([m,f,f],null)),44:new r(44,"window_get_stream",new t([m],new _(y,!1,!0,!0))),45:new r(45,"window_set_echo_stream",new t([m,y],null)),46:new r(46,"window_get_echo_stream",new t([m],new _(y,!1,!0,!0))),47:new r(47,"set_window",new t([m],null)),48:new r(48,"window_get_sibling",new t([m],new _(m,!1,!0,!0))),64:new r(64,"stream_iterate",new t([y,new _(f,!1,!0,!1)],new _(y,!1,!0,!0))),65:new r(65,"stream_get_rock",new t([y],new _(f,!1,!0,!0))),66:new r(66,"stream_open_file",new t([k,f,f],new _(y,!1,!0,!0))),67:new r(67,"stream_open_memory",new t([new o(d,!0,!0,!0,!1),f,f],new _(y,!1,!0,!0))),68:new r(68,"stream_close",new t([y,new _(new u(new t([f,f],null)),!1,!0,!1)],null)),69:new r(69,"stream_set_position",new t([y,g,f],null)),70:new r(70,"stream_get_position",new t([y],new _(f,!1,!0,!0))),71:new r(71,"stream_set_current",new t([y],null)),72:new r(72,"stream_get_current",new t([],new _(y,!1,!0,!0))),73:new r(73,"stream_open_resource",new t([f,f],new _(y,!1,!0,!0))),96:new r(96,"fileref_create_temp",new t([f,f],new _(k,!1,!0,!0))),97:new r(97,"fileref_create_by_name",new t([f,new w,f],new _(k,!1,!0,!0))),98:new r(98,"fileref_create_by_prompt",new t([f,f,f],new _(k,!1,!0,!0))),99:new r(99,"fileref_destroy",new t([k],null)),100:new r(100,"fileref_iterate",new t([k,new _(f,!1,!0,!1)],new _(k,!1,!0,!0))),101:new r(101,"fileref_get_rock",new t([k],new _(f,!1,!0,!0))),102:new r(102,"fileref_delete_file",new t([k],null)),103:new r(103,"fileref_does_file_exist",new t([k],new _(f,!1,!0,!0))),104:new r(104,"fileref_create_from_fileref",new t([f,k,f],new _(k,!1,!0,!0))),128:new r(128,"put_char",new t([h],null)),129:new r(129,"put_char_stream",new t([y,h],null)),130:new r(130,"put_string",new t([new w],null)),131:new r(131,"put_string_stream",new t([y,new w],null)),132:new r(132,"put_buffer",new t([new o(d,!1,!0,!1,!0)],null)),133:new r(133,"put_buffer_stream",new t([y,new o(d,!1,!0,!1,!0)],null)),134:new r(134,"set_style",new t([f],null)),135:new r(135,"set_style_stream",new t([y,f],null)),144:new r(144,"get_char_stream",new t([y],new _(g,!1,!0,!0))),145:new r(145,"get_line_stream",new t([y,new o(d,!1,!1,!0,!0)],new _(f,!1,!0,!0))),146:new r(146,"get_buffer_stream",new t([y,new o(d,!1,!1,!0,!0)],new _(f,!1,!0,!0))),160:new r(160,"char_to_lower",new t([h],new _(h,!1,!0,!0))),161:new r(161,"char_to_upper",new t([h],new _(h,!1,!0,!0))),176:new r(176,"stylehint_set",new t([f,f,f,g],null)),177:new r(177,"stylehint_clear",new t([f,f,f],null)),178:new r(178,"style_distinguish",new t([m,f,f],new _(f,!1,!0,!0))),179:new r(179,"style_measure",new t([m,f,f,new _(f,!1,!0,!1)],new _(f,!1,!0,!0))),192:new r(192,"select",new t([new _(new u(new t([f,m,f,f],null)),!1,!0,!0)],null)),193:new r(193,"select_poll",new t([new _(new u(new t([f,m,f,f],null)),!1,!0,!0)],null)),208:new r(208,"request_line_event",new t([m,new o(d,!0,!0,!0,!0),f],null)),209:new r(209,"cancel_line_event",new t([m,new _(new u(new t([f,m,f,f],null)),!1,!0,!1)],null)),210:new r(210,"request_char_event",new t([m],null)),211:new r(211,"cancel_char_event",new t([m],null)),212:new r(212,"request_mouse_event",new t([m],null)),213:new r(213,"cancel_mouse_event",new t([m],null)),214:new r(214,"request_timer_events",new t([f],null)),224:new r(224,"image_get_info",new t([f,new _(f,!1,!0,!1),new _(f,!1,!0,!1)],new _(f,!1,!0,!0))),225:new r(225,"image_draw",new t([m,f,g,g],new _(f,!1,!0,!0))),226:new r(226,"image_draw_scaled",new t([m,f,g,g,f,f],new _(f,!1,!0,!0))),232:new r(232,"window_flow_break",new t([m],null)),233:new r(233,"window_erase_rect",new t([m,g,g,f,f],null)),234:new r(234,"window_fill_rect",new t([m,f,g,g,f,f],null)),235:new r(235,"window_set_background_color",new t([m,f],null)),240:new r(240,"schannel_iterate",new t([v,new _(f,!1,!0,!1)],new _(v,!1,!0,!0))),241:new r(241,"schannel_get_rock",new t([v],new _(f,!1,!0,!0))),242:new r(242,"schannel_create",new t([f],new _(v,!1,!0,!0))),243:new r(243,"schannel_destroy",new t([v],null)),244:new r(244,"schannel_create_ext",new t([f,f],new _(v,!1,!0,!0))),247:new r(247,"schannel_play_multi",new t([new o(v,!1,!0,!1,!0),new o(f,!1,!0,!1,!0),f],new _(f,!1,!0,!0))),248:new r(248,"schannel_play",new t([v,f],new _(f,!1,!0,!0))),249:new r(249,"schannel_play_ext",new t([v,f,f,f],new _(f,!1,!0,!0))),250:new r(250,"schannel_stop",new t([v],null)),251:new r(251,"schannel_set_volume",new t([v,f],null)),252:new r(252,"sound_load_hint",new t([f,f],null)),253:new r(253,"schannel_set_volume_ext",new t([v,f,f,f],null)),254:new r(254,"schannel_pause",new t([v],null)),255:new r(255,"schannel_unpause",new t([v],null)),256:new r(256,"set_hyperlink",new t([f],null)),257:new r(257,"set_hyperlink_stream",new t([y,f],null)),258:new r(258,"request_hyperlink_event",new t([m],null)),259:new r(259,"cancel_hyperlink_event",new t([m],null)),288:new r(288,"buffer_to_lower_case_uni",new t([new o(f,!1,!0,!0,!0),f],new _(f,!1,!0,!0))),289:new r(289,"buffer_to_upper_case_uni",new t([new o(f,!1,!0,!0,!0),f],new _(f,!1,!0,!0))),290:new r(290,"buffer_to_title_case_uni",new t([new o(f,!1,!0,!0,!0),f,f],new _(f,!1,!0,!0))),291:new r(291,"buffer_canon_decompose_uni",new t([new o(f,!1,!0,!0,!0),f],new _(f,!1,!0,!0))),292:new r(292,"buffer_canon_normalize_uni",new t([new o(f,!1,!0,!0,!0),f],new _(f,!1,!0,!0))),296:new r(296,"put_char_uni",new t([f],null)),297:new r(297,"put_string_uni",new t([new l],null)),298:new r(298,"put_buffer_uni",new t([new o(f,!1,!0,!1,!0)],null)),299:new r(299,"put_char_stream_uni",new t([y,f],null)),300:new r(300,"put_string_stream_uni",new t([y,new l],null)),301:new r(301,"put_buffer_stream_uni",new t([y,new o(f,!1,!0,!1,!0)],null)),304:new r(304,"get_char_stream_uni",new t([y],new _(g,!1,!0,!0))),305:new r(305,"get_buffer_stream_uni",new t([y,new o(f,!1,!1,!0,!0)],new _(f,!1,!0,!0))),306:new r(306,"get_line_stream_uni",new t([y,new o(f,!1,!1,!0,!0)],new _(f,!1,!0,!0))),312:new r(312,"stream_open_file_uni",new t([k,f,f],new _(y,!1,!0,!0))),313:new r(313,"stream_open_memory_uni",new t([new o(f,!0,!0,!0,!1),f,f],new _(y,!1,!0,!0))),314:new r(314,"stream_open_resource_uni",new t([f,f],new _(y,!1,!0,!0))),320:new r(320,"request_char_event_uni",new t([m],null)),321:new r(321,"request_line_event_uni",new t([m,new o(f,!0,!0,!0,!0),f],null)),336:new r(336,"set_echo_line_event",new t([m,f],null)),337:new r(337,"set_terminators_line_event",new t([m,new o(f,!1,!0,!1,!1)],null)),352:new r(352,"current_time",new t([new _(new u(new t([g,f,g],null)),!1,!0,!0)],null)),353:new r(353,"current_simple_time",new t([f],new _(g,!1,!0,!0))),360:new r(360,"time_to_date_utc",new t([new _(new u(new t([g,f,g],null)),!0,!1,!0),new _(new u(new t([g,g,g,g,g,g,g,g],null)),!1,!0,!0)],null)),361:new r(361,"time_to_date_local",new t([new _(new u(new t([g,f,g],null)),!0,!1,!0),new _(new u(new t([g,g,g,g,g,g,g,g],null)),!1,!0,!0)],null)),362:new r(362,"simple_time_to_date_utc",new t([g,f,new _(new u(new t([g,g,g,g,g,g,g,g],null)),!1,!0,!0)],null)),363:new r(363,"simple_time_to_date_local",new t([g,f,new _(new u(new t([g,g,g,g,g,g,g,g],null)),!1,!0,!0)],null)),364:new r(364,"date_to_time_utc",new t([new _(new u(new t([g,g,g,g,g,g,g,g],null)),!0,!1,!0),new _(new u(new t([g,f,g],null)),!1,!0,!0)],null)),365:new r(365,"date_to_time_local",new t([new _(new u(new t([g,g,g,g,g,g,g,g],null)),!0,!1,!0),new _(new u(new t([g,f,g],null)),!1,!0,!0)],null)),366:new r(366,"date_to_simple_time_utc",new t([new _(new u(new t([g,g,g,g,g,g,g,g],null)),!0,!1,!0),f],new _(g,!1,!0,!0))),367:new r(367,"date_to_simple_time_local",new t([new _(new u(new t([g,g,g,g,g,g,g,g],null)),!0,!1,!0),f],new _(g,!1,!0,!0))),4352:new r(4352,"garglk_set_zcolors",new t([f,f],null)),4353:new r(4353,"garglk_set_zcolors_stream",new t([y,f,f],null)),4354:new r(4354,"garglk_set_reversevideo",new t([f],null)),4355:new r(4355,"garglk_set_reversevideo_stream",new t([y,f],null))};function x(e,n,r){return e instanceof i?n?e.signed?r+" & 0xFFFFFFFF":r:"0":e instanceof s?n?e.signed?"self.cast_signed_char("+r+")":r+" & 0xFF":"0":e instanceof a?n?'self.class_obj_from_id("'+e.name+'", '+r+")":"null":"???"}function j(e,n){return e instanceof i?n+" >>> 0":e instanceof s?e.signed?"self.uncast_signed_char("+n+")":n+" & 0xFF":e instanceof a?'self.class_obj_to_id("'+e.name+'", '+n+")":"???"}function M(e){return 128&(e&=255)&&(e+=4294967040),e}function E(e,n){return n?n.disprock:0}function F(e,n){return 0!=n&&n?q[e][n]:null}e.arg_int_unsigned=f,e.arg_int_signed=g,e.arg_char_unsigned=h,e.arg_char_native=d,e.arg_char_signed=p,e.cast_signed_char=function(e){return 128&(e&=255)&&(e-=256),e},e.uncast_signed_char=M,e.class_obj_to_id=E,e.class_obj_from_id=F;var z={};var V=null,W=null,S=-1;e.set_blocked_selector=function(e,n){V=e,W=n.slice(0)};var A=[];e.temp_arg_arrays=A;var R=[];e.retained_arrays=R,e.make_arg_array=function(e,n,r,t){var w;e&&(w={arr:e,addr:n,len:r,arg:t},A.push(w))};var G,q={};return function(){var e,r;for(e in G=1+Math.round(1e3*Math.random()),n)r=n[e],q[r]={}}(),{set_vm:function(n){e.VM=n},get_function:function(n){var r,t=z[n];if(void 0===t){if(void 0===(r=b[n]))throw new Error("dispatch: unknown Glk function: "+n);t=function(n){var r,t,c,f,g,h,d,p,m,y,k,v,b,M,E=[],F={},z=0;for(E.push("// no local vars"),E.push("// "+n.id+": "+n.name),f=null,(c=n.proto).retarg&&(f=c.retarg.arg),E.push("var self = this;"),M=Glk.call_may_not_return(n.id),g=0,h=[],r=0;r<c.args.length;r++)if(p=c.args[r],y="glka"+r,h.push(y),F[y]=!0,p instanceof i||p instanceof s||p instanceof a)k=x(p,!0,"callargs["+g+"]"),E.push(y+" = "+k+";"),g+=1;else if(p instanceof _){if(m=p.arg,E.push("if (callargs["+g+"] == 0) {"),p.nonnull?E.push('  throw new Error("glk '+n.name+': null argument");'):E.push("  "+y+" = null;"),E.push("} else {"),m instanceof i||m instanceof s||m instanceof a)E.push("  "+y+" = new Glk.RefBox();"),k=x(m,p.passin,"self.VM.ReadWord(callargs["+g+"])"),E.push("  "+y+".set_value("+k+");");else{if(!(m instanceof u))throw new Error("buildfunc: unsupported refarg type: "+n.name);for(d=m.form.args,E.push("  "+y+" = new Glk.RefStruct("+d.length+");"),t=0;t<d.length;t++)k=x(d[t],p.passin,"self.VM.ReadStructField(callargs["+g+"], "+t+")"),E.push("  "+y+".push_field("+k+");")}E.push("}"),g+=1}else if(p instanceof o)F.glklen=!0,m=p.arg,E.push("if (callargs["+g+"] == 0) {"),p.nonnull?E.push('  throw new Error("glk '+n.name+': null argument");'):E.push("  "+y+" = null;"),E.push("} else {"),E.push("  glklen = callargs["+(g+1)+"];"),E.push("  "+y+" = Array(glklen);"),p.passin&&(F.ix=!0,F.jx=!0,E.push("  for (ix=0, jx=callargs["+g+"]; ix<glklen; ix++, jx+="+m.refsize+") {"),k=x(m,!0,"self.VM.Read"+m.macro+"(jx)"),E.push("    "+y+"[ix] = "+k+";"),E.push("  }")),p.retained&&(0==z&&E.push("  self.temp_arg_arrays.length = 0;"),z+=1,E.push("  self.make_arg_array("+y+", callargs["+g+"], glklen, self."+m.literal+");")),E.push("}"),g+=2;else{if(!(p instanceof w||p instanceof l))throw new Error("buildfunc: unsupported arg type: "+n.name);var V,W;F.ix=!0,F.jx=!0,p instanceof w?(W="0xE0",V="byte_array_to_string"):(W="0xE2",V="uni_array_to_string"),E.push(y+" = Array();"),E.push("jx = callargs["+g+"];"),E.push("if (self.VM.ReadByte(jx) != "+W+') throw new Error("glk '+n.name+': string argument must be unencoded");'),E.push("for (jx+="+p.refsize+"; true; jx+="+p.refsize+") {"),E.push("  ix = self.VM.Read"+p.macro+"(jx);"),E.push("  if (ix == 0) break;"),E.push("  "+y+".push(ix);"),E.push("}"),E.push(y+" = Glk."+V+"("+y+");"),g+=1}for(E.push("if (callargs.length != "+g+') throw "glk '+n.name+': wrong number of arguments";'),f||M?(F.glkret=!0,v="glkret = "):v="",E.push(v+("Glk.glk_"+n.name).replace("glk_gar","gar")+"("+h.join(", ")+");"),console.log(E),M&&(E.push("if (glkret === Glk.DidNotReturn) {"),E.push("  self.set_blocked_selector("+n.id+", callargs);"),E.push("  return glkret;"),E.push("}")),g=0,r=0;r<c.args.length;r++)if(y="glka"+r,(p=c.args[r])instanceof i||p instanceof s||p instanceof a)g+=1;else if(p instanceof _){if(m=p.arg,p.passout){if(E.push("if ("+y+") {"),m instanceof i||m instanceof s||m instanceof a)k=j(m,y+".get_value()"),E.push("  self.VM.WriteWord(callargs["+g+"], "+k+");");else{if(!(m instanceof u))throw new Error("buildfunc: unsupported refarg type: "+n.name);for(d=m.form.args,t=0;t<d.length;t++)k=j(d[t],y+".get_field("+t+")"),E.push("  self.VM.WriteStructField(callargs["+g+"], "+t+", "+k+");")}E.push("}")}g+=1}else if(p instanceof o)m=p.arg,p.passout&&!p.retained&&(E.push("if ("+y+") {"),F.ix=!0,F.jx=!0,E.push("  for (ix=0, jx=callargs["+g+"]; ix<glklen; ix++, jx+="+m.refsize+") {"),k=j(m,y+"[ix]"),E.push("    self.VM.Write"+m.macro+"(jx, "+k+")"),E.push("  }"),E.push("}")),g+=2;else{if(!(p instanceof w||p instanceof l))throw new Error("buildfunc: unsupported arg type: "+n.name);g+=1}for(k in 0!=z&&E.push("self.temp_arg_arrays.length = 0;"),f?(k=j(f,"glkret"),E.push("return "+k+";")):E.push("return 0;"),b=[],F)b.push(k);return b.length&&(E[0]="var "+b.join(", ")+";"),k=E.join("\n"),new Function("callargs",k).bind(e)}(r),z[n]=t}return t},prepare_resume:function(n){192==V?0!=W[0]&&(S=n.get_field(0)>>>0,e.VM.WriteStructField(W[0],0,n.get_field(0)>>>0),e.VM.WriteStructField(W[0],1,E(0,n.get_field(1))),e.VM.WriteStructField(W[0],2,n.get_field(2)>>>0),e.VM.WriteStructField(W[0],3,n.get_field(3)>>>0)):98==V&&e.VM.SetResumeStore(E(0,n)),V=null,W=null},check_autosave:function(){return 192==V&&W&&W.length>0&&(2==S||3==S||4==S||8==S)?W[0]:null},class_register:function(e,n,r){if(void 0===r){if(n.disprock)throw new Error("class_register: object is already registered");n.disprock=G,G++}else{if(n.disprock!=r)throw new Error("class_register: object is not already registered");G<=r&&(G=r+1)}q[e][n.disprock]=n},class_unregister:function(e,n){if(!n.disprock||void 0===q[e][n.disprock])throw new Error("class_unregister: object is not registered");delete q[e][n.disprock],n.disprock=void 0},class_obj_to_id:E,class_obj_from_id:F,retain_array:function(e,n){var r,t;if(e){if(void 0!==n){if(e!==n.arr)throw new Error("retain_array: array does not match useobj");if((t={addr:n.addr,len:n.len,arr:e,arg:c(n.arg)}).len!=e.length)throw new Error("retain_array: array length from useobj does not match")}else for(t=void 0,r=0;r<A.length;r++)if(A[r].arr===e){t=A[r];break}if(void 0===t)throw new Error("retain_array: array is not an argument");for(r=0;void 0!==R[r];r++);R[r]=t}},unretain_array:function(n){var r,t,w;if(n){for(w=void 0,r=0;r<R.length;r++)if(void 0!==R[r]&&R[r].arr===n){w=R[r],delete R[r];break}if(void 0===w)throw new Error("unretain_array: array was never retained");if(w.arg instanceof i)for(r=0,t=w.addr;r<w.len;r++,t+=4)e.VM.WriteWord(t,w.arr[r]>>>0);else{if(!(w.arg instanceof s))throw new Error("unretain_array: unsupported refarg type");if(w.arg.signed)for(r=0,t=w.addr;r<w.len;r++,t++)e.VM.WriteByte(t,M(w.arr[r]));else for(r=0,t=w.addr;r<w.len;r++,t++)e.VM.WriteByte(t,255&w.arr[r])}}},get_retained_array:function(e){var n;for(n=0;n<R.length;n++)if(void 0!==R[n]&&R[n].arr===e)return R[n];return null}}}();

var GiLoad=function(){var e,r,t={vm:null,io:null,spacing:4,use_query_story:!0,default_story:null,set_page_title:!0,default_page_title:"Game",game_format_name:"",exit_warning:"The game session has ended.",image_info_map:null,proxy_url:"https://zcode.appspot.com/proxy/"},a=null,i={},o=null,n={},l={};function f(e){if(e.match(/^(file|data|http|https):/i))return e;var r=document.createElement("div");return r.innerHTML="<a></a>",r.firstChild.href=e,r.innerHTML=r.innerHTML,r.firstChild.href}function d(e){if(null!=t.image_info_map&&(a=t.image_info_map[e]))return a;var r=n["Pict:"+e];if(r){var a={image:e};if("JPEG"==r.type?a.type="jpeg":"PNG "==r.type?a.type="png":a.type="????",void 0===r.imagesize){var i=void 0;"JPEG"==r.type?i=function(e){var r=0;for(;r<e.length;){if(255!=e[r])return void GlkOte.log("find_dimensions_jpeg: marker is not 0xFF");for(;255==e[r];)r+=1;var t=e[r];if(r+=1,!(1==t||t>=208&&t<=217)){var a=e[r+0]<<8|e[r+1];if(t>=192&&t<=207&&200!=t){if(a<7)return void GlkOte.log("find_dimensions_jpeg: SOF block is too small");var i={};return i.height=e[r+3]<<8|e[r+4],i.width=e[r+5]<<8|e[r+6],i}r+=a}}return void GlkOte.log("find_dimensions_jpeg: no SOF marker found")}(r.content):"PNG "==r.type&&(i=function(e){var r=0;if(137!=e[0]||"PNG"!=String.fromCharCode.apply(this,e.slice(1,4)))return void GlkOte.log("find_dimensions_png: PNG signature does not match");r+=8;for(;r<e.length;){var t=e[r+0]<<24|e[r+1]<<16|e[r+2]<<8|e[r+3];r+=4;var a=String.fromCharCode.apply(this,e.slice(r,r+4));if(r+=4,"IHDR"==a){var i={};return i.width=e[r+0]<<24|e[r+1]<<16|e[r+2]<<8|e[r+3],r+=4,i.height=e[r+0]<<24|e[r+1]<<16|e[r+2]<<8|e[r+3],r+=4,i}r+=t,r+=4}return void GlkOte.log("find_dimensions_png: no PNG header block found")}(r.content)),i&&(r.imagesize=i)}r.imagesize&&(a.width=r.imagesize.width,a.height=r.imagesize.height);var o=l["Pict:"+e];return o&&(a.alttext=o),a}}function s(e){for(var r,t=[],a=0;a<e.length;){var i,o,n,l;if(a>=e.length)break;if(i=e[a],a++,i<128)r=i;else{if(a>=e.length)break;if(o=e[a],a++,128!=(192&o))break;if(192==(224&i))r=(31&i)<<6,r|=63&o;else{if(a>=e.length)break;if(n=e[a],a++,128!=(192&n))break;if(224==(240&i))r=(15&i)<<12&61440,r|=(63&o)<<6&4032,r|=63&n;else{if(240!=(240&i))break;if(a>=e.length)break;if(l=e[a],a++,128!=(192&l))break;r=(7&i)<<18&1835008,r|=(63&o)<<12&258048,r|=(63&n)<<6&4032,r|=63&l}}}t.push(r)}return String.fromCharCode.apply(this,t)}if(window.atob)r=function(e){var r,t=atob(e),a=Array(t.length);for(r=0;r<t.length;r++)a[r]=t.charCodeAt(r);return a};else{var u=function(){var e,r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t=[];for(e=0;e<r.length;e++)t[r.charAt(e)]=e;return t}();r=function(e){for(var r,t,a,i,o,n,l=[],f=0,d=e.length;f<d;)r=(u[e.charAt(f++)]<<2)+((i=u[e.charAt(f++)])>>4),t=((15&i)<<4)+((o=u[e.charAt(f++)])>>2),a=((3&o)<<6)+(n=u[e.charAt(f++)]),l.push(r,t,a);return 64==n&&l.pop(),64==o&&l.pop(),l}}function c(e){if(0!=e.length){if(70==e[0]&&79==e[1]&&82==e[2]&&77==e[3]){var r=String.fromCharCode(e[8],e[9],e[10],e[11]);if("IFZS"==r)return void t.io.fatal_error("This is a saved-game file, not a "+t.game_format_name+" game file. You must launch the game first, then restore your save.");if("IFRS"!=r)return void t.io.fatal_error("This IFF file is not a Blorb file!");if(t.blorb_gamechunk_type)try{e=function(e,r){for(var a,f=e.length,d=[],u=null,c=12;c<f;){var g=String.fromCharCode(e[c+0],e[c+1],e[c+2],e[c+3]),p=e[(c+=4)+0]<<24|e[c+1]<<16|e[c+2]<<8|e[c+3];if(c+=4,"RIdx"==g){var h=e[(w=c)+0]<<24|e[w+1]<<16|e[w+2]<<8|e[w+3];for(w+=4,a=0;a<h;a++){var m=String.fromCharCode(e[w+0],e[w+1],e[w+2],e[w+3]),_=e[(w+=4)+0]<<24|e[w+1]<<16|e[w+2]<<8|e[w+3],v=e[(w+=4)+0]<<24|e[w+1]<<16|e[w+2]<<8|e[w+3];w+=4,d.push({usage:m,num:_,pos:v})}}if("IFmd"==g){var y=s(G=e.slice(c,c+p)),b=$("<metadata>").html(y).find("bibliographic").children();if(b.length)for(a=0;a<b.length;a++)T=b[a],i[T.tagName.toLowerCase()]=T.textContent}if("Dbug"==g&&t.debug_info_chunk){var G=e.slice(c,c+p);o=G}if("RDes"==g){var w,k=e[(w=c)+0]<<24|e[w+1]<<16|e[w+2]<<8|e[w+3];for(w+=4,a=0;a<k;a++){var x=String.fromCharCode.apply(this,e.slice(w,w+4)),C=e[(w+=4)+0]<<24|e[w+1]<<16|e[w+2]<<8|e[w+3],j=e[(w+=4)+0]<<24|e[w+1]<<16|e[w+2]<<8|e[w+3];w+=4;var O=s(e.slice(w,w+j));w+=j,l[x+":"+C]=O}}1&(c+=p)&&c++}for(a=0;a<d.length;a++){var T;c=(T=d[a]).pos;g=String.fromCharCode(e[c+0],e[c+1],e[c+2],e[c+3]),p=e[(c+=4)+0]<<24|e[c+1]<<16|e[c+2]<<8|e[c+3];c+=4,T.type=g,T.len=p,T.content=null,"Exec"==T.usage&&0==T.num&&g==r?u=e.slice(c,c+p):(T.content="FORM"==g?e.slice(c-8,c+p):e.slice(c,c+p),n[T.usage+":"+T.num]=T)}return u}(e,t.blorb_gamechunk_type)}catch(e){return void t.io.fatal_error("Blorb file could not be parsed: "+e)}if(!e)return void t.io.fatal_error("Blorb file contains no "+t.game_format_name+" game!")}var f=null;i&&(f=i.title),!f&&a&&(f=a.slice(a.lastIndexOf("/")+1)),f||(f=t.default_page_title),f||(f="Game"),t.recording_label||(t.recording_label=f),t.set_page_title&&(document.title=f+" - "+t.engine_name),t.vm.prepare(e,t),t.io.init(t)}else t.io.fatal_error("No game file was loaded. (Zero-length response.)")}return e=window.btoa?function(e){for(var r=[],t=e.length,a=0;a<t;a+=16384)r.push(String.fromCharCode.apply(String,e.slice(a,a+16384)));return btoa(r.join(""))}:function(e){for(var r,t,a,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",o=[],n=0;n<e.length;n+=3)r=e[n],t=e[n+1],a=e[n+2],o.push(i.charAt(r>>2&63)),o.push(i.charAt(r<<4&48|t>>4&15)),o.push(i.charAt(t<<2&60|a>>6&3)),o.push(i.charAt(63&a));return void 0===t&&o.length>=2&&(o[o.length-2]="="),void 0===a&&o.length>=1&&(o[o.length-1]="="),o.join("")},{load_run:function(e,i,o){o?"string"==typeof o&&(o={format:o}):o={};var n=o.format;if(n||(n="array"),t.io=window.Glk,t.vm=window.Quixe,e||(e=window.game_options),!e||!window.Quixe||e.vm&&e.vm!==window.Quixe||(t.engine_name="Quixe",t.blorb_gamechunk_type="GLUL",t.game_format_name="Glulx"),e&&jQuery.extend(t,e),null!=t.image_info_map&&"string"===jQuery.type(t.image_info_map)&&(window[t.image_info_map]?t.image_info_map=window[t.image_info_map]:delete t.image_info_map),a=null,t.use_query_story){var l=function(){var e={},r=location.search.substring(1,location.search.length);if(r.length){var t=r.split("&");r=r.replace(/\+/g," ");for(var a=0;a<t.length;a++){var i=t[a].split("="),o=decodeURIComponent(i[0]),n=2==i.length?decodeURIComponent(i[1]):o;e[o]=n}}return e}();a=l.story}if(a||!i)if(a||(a=t.default_story),a){i=null;var d=new XMLHttpRequest,s=void 0!==d.overrideMimeType,u=void 0!==d.withCredentials;d=null;var g=/^(file:|(\w+:)?\/\/[^\/?#]+)/,p=g.exec(location)[0],h=g.exec(a),m=!h,_=h?h[0]:p,v=p==_;navigator.userAgent.match(/chrome/i)&&"file:"==_&&(v=!1);var y=a.match(/[.]js$/i);if(GlkOte.log("GiLoad: is_relative="+m+", same_origin="+v+", binary_supported="+s+", crossorigin_supported="+u),y&&v)return GlkOte.log("GiLoad: trying old-fashioned load..."),window.processBase64Zcode=function(e){c(r(e))},void jQuery.ajax(a,{type:"GET",dataType:"script",cache:!0,error:function(e,r,i){t.io.fatal_error("The story could not be loaded. ("+a+"): Error "+r+": "+i)}});if(y){if(GlkOte.log("GiLoad: trying script load..."),window.processBase64Zcode=function(e){c(r(e))},!(w=$("head")).length)return void t.io.fatal_error("This page has no <head> element!");var b=$("<script>",{src:a,type:"text/javascript"});w.get(0).appendChild(b.get(0))}else{if(s&&v)return GlkOte.log("GiLoad: trying binary load..."),void jQuery.ajax(a,{type:"GET",beforeSend:function(e,r){e.overrideMimeType("text/plain; charset=x-user-defined")},success:function(e,r,t){c(function(e){var r,t=Array(e.length);for(r=0;r<e.length;r++)t[r]=255&e.charCodeAt(r);return t}(e))},error:function(e,r,i){t.io.fatal_error("The story could not be loaded. ("+a+"): Error "+r+": "+i)}});if("file:"!=_){var G=a;if(m&&(G=f(a),GlkOte.log("GiLoad: absolutize "+a+" to "+G)),u)return GlkOte.log("GiLoad: trying proxy load... ("+t.proxy_url+")"),void jQuery.ajax(t.proxy_url,{type:"GET",data:{encode:"base64",url:G},error:function(e,r,i){t.io.fatal_error("The story could not be loaded. ("+a+"): Error "+r+": "+i)},success:function(e,t,a){c(r(e))}});var w,k=t.proxy_url+"?encode=base64&callback=processBase64Zcode&url="+G;if(GlkOte.log("GiLoad: trying proxy-script load... ("+k+")"),window.processBase64Zcode=function(e){c(r(e))},(w=$("head")).length){b=$("<script>",{src:k,type:"text/javascript"});w.append(b)}else t.io.fatal_error("This page has no <head> element!")}else t.io.fatal_error("The story could not be loaded. ("+a+"): A local file cannot be sent to the proxy.")}}else t.io.fatal_error("No story file specified!");else{switch(GlkOte.log("GiLoad: trying pre-loaded load ("+n+")..."),n){case"base64":i=r(i);break;case"raw":i=decode_text(i);break;case"array":break;default:return void t.io.fatal_error("Could not decode story file data: "+n)}c(i)}},find_data_chunk:function(e){var r=n["Data:"+e];if(!r)return null;var t=r.type;return"FORM"==t&&(t="BINA"),{data:r.content,type:t}},get_metadata:function(e){return i[e]},get_debug_info:function(){return o},get_image_info:d,get_image_url:function(r){if(t.image_info_map){var a=t.image_info_map[r];if(a&&a.url)return f(a.url)}var i=n["Pict:"+r];if(i){if(i.dataurl)return i.dataurl;if(d(r)&&i.content){var o="application/octet-stream";"JPEG"==i.type?o="image/jpeg":"PNG "==i.type&&(o="image/png");var l=e(i.content);return i.dataurl="data:"+o+";base64,"+l,i.dataurl}}}}}();