var Dialog=function(){var dialog_el_id="dialog",is_open=!1,dialog_callback=null,will_save,confirming,editing,editing_dirent,cur_usage,cur_usage_name,cur_gameid,cur_filelist;function dialog_open(e,t,i,n){if(is_open)throw new Error("Dialog: dialog box is already open.");if(!Storage)throw new Error("Dialog: no storage API is available.");dialog_callback=n,will_save=e,confirming=!1,editing=!1,editing_dirent=null,cur_gameid=i,cur_usage_name=label_for_usage(cur_usage=t);var a="windowport",l=window.Game;window.GlkOte&&(l=window.GlkOte.getinterface()),l&&l.windowport&&(a=l.windowport);var r=$("#"+a);if(!r.length)throw new Error("Dialog: unable to find root element #"+a+".");var o=$("#"+dialog_el_id+"_screen");o.length||(o=$("<div>",{id:dialog_el_id+"_screen"}),r.append(o));var d=$("#"+dialog_el_id+"_frame");d.length||(d=$("<div>",{id:dialog_el_id+"_frame"}),r.append(d));var _,c,s,g=$("#"+dialog_el_id);g.length&&g.remove(),g=$("<div>",{id:dialog_el_id}),(_=$("<form>")).on("submit",will_save?evhan_accept_save_button:evhan_accept_load_button),g.append(_),s=$("<div>",{class:"DiaButtonsFloat"}),(c=$("<button>",{id:dialog_el_id+"_edit",type:"button"})).append("Edit"),c.on("click",evhan_edit_button),s.append(c),_.append(s),(s=$("<div>",{id:dialog_el_id+"_cap",class:"DiaCaption"})).append("XXX"),_.append(s),will_save&&(s=$("<div>",{id:dialog_el_id+"_input",class:"DiaInput"}),_.append(s),c=$("<input>",{id:dialog_el_id+"_infield",type:"text",name:"filename"}),s.append(c)),s=$("<div>",{id:dialog_el_id+"_body",class:"DiaBody"}),_.append(s),(s=$("<div>",{id:dialog_el_id+"_cap2",class:"DiaCaption"})).hide(),_.append(s),s=$("<div>",{id:dialog_el_id+"_buttonrow",class:"DiaButtons"}),(c=$("<button>",{id:dialog_el_id+"_cancel",type:"button"})).append("Cancel"),c.on("click",evhan_cancel_button),s.append(c),(c=$("<button>",{id:dialog_el_id+"_delete",type:"button"})).append("Delete"),c.on("click",evhan_delete_button),c.hide(),s.append(c),(c=$("<button>",{id:dialog_el_id+"_display",type:"button"})).append("Display"),c.on("click",evhan_display_button),c.hide(),s.append(c),(c=$("<button>",{id:dialog_el_id+"_accept",type:"submit"})).append(will_save?"Save":"Load"),c.on("click",will_save?evhan_accept_save_button:evhan_accept_load_button),s.append(c),_.append(s),d.append(g),is_open=!0,evhan_storage_changed(),defer_func(will_save?function(){var e=$("#"+dialog_el_id+"_infield");e.length&&e.focus()}:function(){var e=$("#"+dialog_el_id+"_select");e.length&&e.focus()})}function dialog_close(){var e=$("#"+dialog_el_id);e.length&&e.remove();var t=$("#"+dialog_el_id+"_frame");t.length&&t.remove();var i=$("#"+dialog_el_id+"_screen");i.length&&i.remove(),is_open=!1,dialog_callback=null,cur_filelist=null,editing=!1,editing_dirent=null}function set_caption(e,t){var i=$("#"+(t?dialog_el_id+"_cap":dialog_el_id+"_cap2"));i.length&&(e?(i.text(e),i.show()):i.hide())}function label_for_usage(e){switch(e){case"data":return"data file";case"save":return"save file";case"transcript":return"transcript";case"command":return"command script";default:return"file"}}function usage_is_textual(e){return"transcript"==e||"command"==e}function defer_func(e){return window.setTimeout(e,10)}function evhan_select_change(){if(!is_open)return!1;if(confirming)return!1;var e=$("#"+dialog_el_id+"_select");if(!e.length)return!1;var t=e.prop("selectedIndex");if(!cur_filelist||t<0||t>=cur_filelist.length)return!1;var i=cur_filelist[t],n=$("#"+dialog_el_id+"_infield");return!!n.length&&(n.val(i.dirent.filename),!1)}function evhan_select_change_editing(){if(!is_open)return!1;if(!editing||editing_dirent)return!1;var e=$("#"+dialog_el_id+"_delete");e.prop("disabled",!0),(e=$("#"+dialog_el_id+"_display")).prop("disabled",!0);var t=$("#"+dialog_el_id+"_select");if(!t.length)return!1;var i=t.prop("selectedIndex");if(!cur_filelist||i<0||i>=cur_filelist.length)return!1;var n=cur_filelist[i];if(!n||!n.dirent||!file_ref_exists(n.dirent))return!1;(e=$("#"+dialog_el_id+"_delete")).prop("disabled",!1),(e=$("#"+dialog_el_id+"_display")).prop("disabled",!1)}function evhan_accept_load_button(e){if(e.preventDefault(),!is_open)return!1;if(editing)return!1;var t=$("#"+dialog_el_id+"_select");if(!t.length)return!1;var i=t.prop("selectedIndex");if(!cur_filelist||i<0||i>=cur_filelist.length)return!1;var n=cur_filelist[i];if(!n||!n.dirent||!file_ref_exists(n.dirent))return!1;var a=dialog_callback;return dialog_close(),a&&a(n.dirent),!1}function evhan_accept_save_button(e){if(e.preventDefault(),!is_open)return!1;if(editing)return!1;var t=$("#"+dialog_el_id+"_infield");if(!t.length)return!1;var i=t.val();if(!(i=jQuery.trim(i)).length)return!1;var n=file_construct_ref(i,cur_usage,cur_gameid);if(file_ref_exists(n)&&!confirming)return confirming=!0,set_caption("You already have a "+cur_usage_name+' "'+n.filename+'". Do you want to replace it?',!1),t.prop("disabled",!0),$("#"+dialog_el_id+"_accept").text("Replace"),!1;var a=dialog_callback;return dialog_close(),a&&a(n),!1}function evhan_edit_button(e){return e.preventDefault(),!!is_open&&(editing?editing_dirent?(editing=!0,editing_dirent=null,$("#"+dialog_el_id+"_buttonrow").show(),(i=$("#"+dialog_el_id+"_edit")).text("Done"),evhan_storage_changed(),!1):(editing=!1,editing_dirent=null,(t=$("#"+dialog_el_id+"_input")).length&&t.show(),(i=$("#"+dialog_el_id+"_edit")).text("Edit"),(i=$("#"+dialog_el_id+"_delete")).hide(),(i=$("#"+dialog_el_id+"_display")).hide(),(i=$("#"+dialog_el_id+"_accept")).show(),evhan_storage_changed(),!1):(editing=!0,editing_dirent=null,confirming&&(confirming=!1,set_caption(null,!1),(t=$("#"+dialog_el_id+"_infield")).prop("disabled",!1),(i=$("#"+dialog_el_id+"_accept")).prop("disabled",!1),i.text("Save")),(t=$("#"+dialog_el_id+"_input")).length&&t.hide(),(i=$("#"+dialog_el_id+"_edit")).text("Done"),(i=$("#"+dialog_el_id+"_delete")).show(),(i=$("#"+dialog_el_id+"_display")).show(),(i=$("#"+dialog_el_id+"_accept")).hide(),evhan_storage_changed(),!1));var t,i}function evhan_delete_button(e){if(e.preventDefault(),!is_open)return!1;if(!editing||editing_dirent)return!1;var t=$("#"+dialog_el_id+"_select");if(!t.length)return!1;var i=t.prop("selectedIndex");if(!cur_filelist||i<0||i>=cur_filelist.length)return!1;var n=cur_filelist[i];return!(!n||!n.dirent)&&(file_remove_ref(n.dirent),evhan_storage_changed(),!1)}function evhan_display_button(e){if(e.preventDefault(),!is_open)return!1;if(!editing||editing_dirent)return!1;var t=$("#"+dialog_el_id+"_select");if(!t.length)return!1;var i=t.prop("selectedIndex");if(!cur_filelist||i<0||i>=cur_filelist.length)return!1;var n=cur_filelist[i];return!!(n&&n.dirent&&file_ref_exists(n.dirent))&&($("#"+dialog_el_id+"_buttonrow").hide(),$("#"+dialog_el_id+"_edit").text("Close"),editing_dirent=n.dirent,evhan_storage_changed(),!1)}function evhan_cancel_button(e){if(e.preventDefault(),!is_open)return!1;if(confirming){confirming=!1,set_caption(null,!1),$("#"+dialog_el_id+"_infield").prop("disabled",!1);var t=$("#"+dialog_el_id+"_accept");return t.prop("disabled",!1),t.text("Save"),!1}var i=dialog_callback;return dialog_close(),i&&i(null),!1}function evhan_storage_changed(e){if(!is_open)return!1;var t,i,n,a;if(e&&e.key,!(i=$("#"+dialog_el_id+"_body")).length)return!1;if(editing&&editing_dirent&&(file_ref_exists(editing_dirent)||(editing_dirent=null,$("#"+dialog_el_id+"_buttonrow").show(),$("#"+dialog_el_id+"_edit").text("Done"))),editing&&editing_dirent){i.empty();var l=file_read(editing_dirent);if(l=String.fromCharCode.apply(this,l),usage_is_textual(editing_dirent.usage)){var r=$("<pre>",{class:"DiaDisplayText"});r.text(l),i.append(r),set_caption("Displaying file contents...",!0)}else{var o=window.btoa(l),d=$("<a>",{href:"data:application/octet-stream;base64,"+o,target:"_blank",download:"data"});d.text(editing_dirent.filename),i.append(d),set_caption('Use "Save As" option in your browser to download this link.',!0)}return!1}if(editing){if(n=files_list(null,cur_gameid),""!=cur_gameid&&(n=n.concat(files_list(null,""))),n.sort(function(e,t){return e.dirent.usage<t.dirent.usage?-1:e.dirent.usage>t.dirent.usage?1:t.modified.getTime()-e.modified.getTime()}),0==n.length)return i.empty(),$("#"+dialog_el_id+"_delete").prop("disabled",!0),$("#"+dialog_el_id+"_display").prop("disabled",!0),set_caption("You have no stored files. Press Done to continue.",!0),!1;for(cur_filelist=[],a="",s=0;s<n.length;s++)(g=n[s]).dirent.usage!=a&&(a=g.dirent.usage,cur_filelist.push({label:a})),cur_filelist.push(g);n=cur_filelist,i.empty(),(c=$("<select>",{id:dialog_el_id+"_select",name:"files"})).prop("size","5");var _=!1;for(s=0;s<n.length;s++)(g=n[s]).dirent?(t=$("<option>",{name:"f"+s}),_||(_=!0,t.selected=!0),u=format_date(g.modified),t.text(g.dirent.filename+" -- "+u),c.append(t)):((t=$("<option>",{name:"f"+s})).prop("disabled",!0),t.text("-- "+label_for_usage(g.label)+"s --"),c.append(t));return i.append(c),c.on("change",evhan_select_change_editing),evhan_select_change_editing(),set_caption("All stored files are now visible. You may delete them, and display files containing text. Press Done when finished.",!0),!1}if((n=files_list(cur_usage,cur_gameid)).sort(function(e,t){return t.modified.getTime()-e.modified.getTime()}),cur_filelist=n,0==n.length)i.empty();else{var c,s,g,u;for(i.empty(),(c=$("<select>",{id:dialog_el_id+"_select",name:"files"})).prop("size","5"),s=0;s<n.length;s++)g=n[s],t=$("<option>",{name:"f"+s}),0==s&&(t.selected=!0),u=format_date(g.modified),t.text(g.dirent.filename+" -- "+u),c.append(t);i.append(c),will_save&&c.on("change",evhan_select_change)}will_save?(set_caption("Name this "+cur_usage_name+".",!0),(t=$("#"+dialog_el_id+"_accept")).prop("disabled",!1)):0==n.length?(set_caption("You have no "+cur_usage_name+"s for this game.",!0),(t=$("#"+dialog_el_id+"_accept")).prop("disabled",!0)):(set_caption("Select a "+cur_usage_name+" to load.",!0),(t=$("#"+dialog_el_id+"_accept")).prop("disabled",!1))}function file_clean_fixed_name(e,t){return e}function file_construct_ref(e,t,i){e||(e=""),t||(t=""),i||(i="");var n=t+":"+i+":"+e;return{dirent:"dirent:"+n,content:"content:"+n,filename:e,usage:t,gameid:i}}function file_construct_temp_ref(e){var t="_temp_"+(new Date).getTime()+"_"+Math.random();return file_construct_ref(t=t.replace(".",""),e)}function file_decode_ref(e){if("dirent:"!=e.slice(0,7))return null;var t=7,i=e.indexOf(":",t);if(i<0)return null;var n=e.slice(t,i);if(t=i+1,(i=e.indexOf(":",t))<0)return null;var a=e.slice(t,i);t=i+1;var l=e.slice(t),r="cont"+e.slice(3);return{dirent:e,content:r,filename:l,usage:n,gameid:a}}function file_load_dirent(e){if("object"!=typeof e&&!(e=file_decode_ref(e)))return null;var t=Storage.getItem(e.dirent);if(!t)return null;var i,n,a,l,r={dirent:e},o=t.toString().split(",");for(i=0;i<o.length;i++)if(!((n=(l=o[i]).indexOf(":"))<0))switch(a=l.slice(0,n),l=l.slice(n+1),a){case"created":r.created=new Date(Number(l));break;case"modified":r.modified=new Date(Number(l))}return r}function file_ref_exists(e){return!!Storage.getItem(e.dirent)}function file_remove_ref(e){Storage.removeItem(e.dirent),Storage.removeItem(e.content)}function file_write(e,t,i){var n,a,l,r,o=file_load_dirent(e);return o||(o={dirent:e,created:new Date}),o.modified=new Date,i||(t=encode_array(t)),a=[],o.created&&a.push("created:"+o.created.getTime()),o.modified&&a.push("modified:"+o.modified.getTime()),n=a.join(","),l=Storage.setItem(o.dirent.dirent,n),r=Storage.setItem(o.dirent.content,t),!l&&!r}function file_read(e,t){if(!file_load_dirent(e))return null;var i=Storage.getItem(e.content);return null==i?null:(i=i.toString())?t?i:decode_array(i):t?"":[]}function file_notimplemented(){throw new Error("streaming function not implemented in Dialog")}function file_ref_matches(e,t,i){return(null==t||e.usage==t)&&(null==i||e.gameid==i)}function files_list(e,t){var i,n=[];if(!Storage)return n;var a=Storage.getKeys();for(i=0;i<a.length;i++){var l=a[i];if(l){var r=file_decode_ref(l.toString());if(r&&file_ref_matches(r,e,t)){var o=file_load_dirent(r);n.push(o)}}}return n}function format_date(e){return e?e.getMonth()+1+"/"+e.getDate()+" "+(e.getHours()+":"+(e.getMinutes()<10?"0":"")+e.getMinutes()):"???"}function autosave_write(e,t){var i="autosave:"+e;t?Storage.setItem(i,JSON.stringify(t)):Storage.removeItem(i)}function autosave_read(e){var t="autosave:"+e,i=Storage.getItem(t);if(i)try{return JSON.parse(i)}catch(e){}return null}var encode_array=null,decode_array=null;window.JSON?(encode_array=function(e){var t=JSON.stringify(e),i=t.length;return'"'==t[0]&&'"'==t[i-1]&&(t=t.slice(1,i-1)),t},decode_array=function(e){return JSON.parse(e)}):(encode_array=function(e){return"["+e+"]"},decode_array=function(val){return eval(val)});var Storage=null;try{var htmlLocalStorage=null;if(null!=window.localStorage?htmlLocalStorage=window.localStorage:null!=window.globalStorage&&(htmlLocalStorage=window.globalStorage[location.hostname]),htmlLocalStorage)try{if(htmlLocalStorage.setItem("_dialogtest","xyzzy"),"xyzzy"!=htmlLocalStorage.getItem("_dialogtest"))throw new Error("localStorage test did not match");htmlLocalStorage.removeItem("_dialogtest"),Storage={getItem:function(e){try{return htmlLocalStorage.getItem(e)}catch(e){return null}},removeItem:function(e){try{htmlLocalStorage.removeItem(e)}catch(e){}},setItem:function(e,t){try{htmlLocalStorage.setItem(e,t)}catch(e){return GlkOte.log("Dialog: localStorage failed! "+e),!0}},getKeys:function(){for(var e=[],t=0;t<htmlLocalStorage.length;t++)e.push(htmlLocalStorage.key(t));return e}}}catch(e){GlkOte.log("Dialog: localStorage not available: "+e),GlkOte.log("Dialog: falling back to window memory")}}catch(e){}return null==Storage&&(Storage={data:{},keys:[],getItem:function(e){return Storage.data[e]},setItem:function(e,t){Storage.keys.indexOf(e)<0&&Storage.keys.push(e),Storage.data[e]=t},removeItem:function(e){var t=Storage.keys.indexOf(e);t>=0&&(Storage.keys.splice(t,1),delete Storage.data[e])},getKeys:function(){return Storage.keys.slice(0)}}),$(window).on("storage",evhan_storage_changed),{streaming:!1,open:dialog_open,file_clean_fixed_name:file_clean_fixed_name,file_construct_ref:file_construct_ref,file_construct_temp_ref:file_construct_temp_ref,file_ref_exists:file_ref_exists,file_remove_ref:file_remove_ref,file_write:file_write,file_read:file_read,file_fopen:file_notimplemented,autosave_write:autosave_write,autosave_read:autosave_read}}();